# 設計書要件定義
# 自動テストによる準拠性検証用の設計仕様
version: "3.0"
document_id: "SYS-DOC-001"

# 7フェーズ処理要件
phase_pipeline:
  total_phases: 7
  required_phases:
    - phase_number: 1
      name: "コンセプト・世界観分析"
      timeout_seconds: 30
      ai_model: "gemini-pro"
      output_type: "concept_analysis"
      critical: false
    - phase_number: 2
      name: "キャラクター設定・簡易ビジュアル生成"
      timeout_seconds: 60
      ai_model: "gemini-pro"
      output_type: "character_design"
      critical: false
    - phase_number: 3
      name: "物語構造化・プロット生成"
      timeout_seconds: 60
      ai_model: "gemini-pro"
      output_type: "story_structure"
      critical: false
    - phase_number: 4
      name: "シーン分割・コマ割り"
      timeout_seconds: 60
      ai_model: "gemini-pro"
      output_type: "scene_layout"
      critical: true
    - phase_number: 5
      name: "画像生成・ビジュアル制作"
      timeout_seconds: 180
      ai_model: "imagen-4"
      output_type: "visual_content"
      critical: true
    - phase_number: 6
      name: "セリフ配置・テキスト統合"
      timeout_seconds: 60
      ai_model: "gemini-pro"
      output_type: "dialogue_integration"
      critical: false
    - phase_number: 7
      name: "最終統合・品質調整"
      timeout_seconds: 120
      ai_model: "image_processing"
      output_type: "final_manga"
      critical: true

# HITL (Human-in-the-Loop) 要件
hitl_requirements:
  feedback_timeout_seconds: 30
  required_feedback_phases: [4, 5, 7]  # Critical phases
  feedback_types:
    - "natural_language"
    - "quick_options"
    - "skip"
  websocket_support: true
  real_time_updates: true

# アーキテクチャ要件
architecture:
  pattern: "monolithic"
  design_patterns:
    - "Domain-Driven Design (DDD)"
    - "Command Query Responsibility Segregation (CQRS)"
    - "Repository Pattern"
    - "Agent Pattern"
  required_layers:
    - "domain"
    - "application" 
    - "infrastructure"
    - "api"
    - "agents"
    - "engine"

# パフォーマンス要件
performance:
  total_processing_time_max: 750  # seconds (12.5 minutes)
  concurrent_users_max: 100
  response_time_max: 5000  # milliseconds
  database_connection_pool: 20
  redis_connection_pool: 10

# セキュリティ要件
security:
  authentication: "Firebase Auth"
  authorization: "JWT"
  https_only: true
  rate_limiting: true
  input_validation: true
  sql_injection_protection: true

# 外部API統合要件
external_apis:
  google_vertex_ai:
    models_required:
      - "gemini-pro"
      - "imagen-4"
    retry_policy:
      max_retries: 3
      backoff_strategy: "exponential"
  required_services:
    - "Cloud Storage"
    - "Secret Manager"

# データベース要件  
database:
  engine: "postgresql"
  required_tables:
    - "users"
    - "manga_projects"
    - "generation_requests"
    - "processing_modules"
    - "preview_versions"
  indexing_required: true
  jsonb_support: true

# WebSocket要件
websocket:
  max_concurrent_connections: 1000
  debounce_ms: 300
  custom_events: true
  session_management: true