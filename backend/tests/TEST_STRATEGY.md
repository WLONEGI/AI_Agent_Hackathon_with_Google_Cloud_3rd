# Backend Design Compliance Testing Strategy

è¨­è¨ˆæ›¸æº–æ‹ æ€§ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½æ–¹é‡ã¨ãƒ„ãƒ¼ãƒ«ä½¿ç”¨æ–¹æ³•

## æ¦‚è¦

ã“ã®ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ãŒè¨­è¨ˆæ›¸ã®è¦ä»¶ã«æº–æ‹ ã—ã¦ã„ã‚‹ã“ã¨ã‚’è‡ªå‹•æ¤œè¨¼ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆCI/CDï¼‰ã«çµ±åˆã•ã‚Œã€è¨­è¨ˆä»•æ§˜ã‹ã‚‰ã®é€¸è„±ã‚’æ—©æœŸã«æ¤œå‡ºã—ã¾ã™ã€‚

## ãƒ†ã‚¹ãƒˆæ§‹æˆ

### 1. ãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª

| ã‚«ãƒ†ã‚´ãƒª | ç›®çš„ | ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ« |
|---------|------|--------------|
| **Design Compliance** | è¨­è¨ˆæ›¸è¦ä»¶æº–æ‹ æ€§ | `tests/compliance/test_design_requirements.py` |
| **Phase Pipeline** | 7ãƒ•ã‚§ãƒ¼ã‚ºãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ¤œè¨¼ | `tests/compliance/test_phase_pipeline_compliance.py` |
| **HITL System** | Human-in-the-Loopæ©Ÿèƒ½ | `tests/compliance/test_hitl_compliance.py` |
| **API Contracts** | APIä»•æ§˜æº–æ‹ æ€§ | `tests/contracts/test_api_contracts.py` |
| **Architecture** | ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ | `tests/compliance/test_architecture_compliance.py` |

### 2. æº–æ‹ æ€§ã‚«ãƒ†ã‚´ãƒª

#### ğŸ”´ Critical (é‡è¦åº¦: é«˜)
- **ãƒ•ã‚§ãƒ¼ã‚ºãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**: 7ãƒ•ã‚§ãƒ¼ã‚ºæ§‹æˆã¨AIãƒ¢ãƒ‡ãƒ«çµ±åˆ
- **HITL ã‚·ã‚¹ãƒ†ãƒ **: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ•ã‚§ãƒ¼ã‚ºã§ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½
- **å“è³ªã‚²ãƒ¼ãƒˆ**: å„ãƒ•ã‚§ãƒ¼ã‚ºã§ã®å“è³ªç®¡ç†

#### ğŸŸ¡ Important (é‡è¦åº¦: ä¸­)
- **APIå¥‘ç´„**: ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³**: DDDãƒ»CQRSå®Ÿè£…
- **WebSocketçµ±åˆ**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡

#### ğŸŸ¢ Recommended (é‡è¦åº¦: ä½)
- **ã‚³ãƒ¼ãƒ‰å“è³ª**: å‘½åè¦å‰‡ã¨ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: APIä»•æ§˜æ›¸ã¨ã®æ•´åˆæ€§
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“è¦ä»¶

## ä½¿ç”¨æ–¹æ³•

### ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./test.sh

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
./test.sh -s compliance
./test.sh -s contracts

# è©³ç´°å‡ºåŠ›ä»˜ãå®Ÿè¡Œ
./test.sh -v

# ãƒ¬ãƒãƒ¼ãƒˆã®ã¿ç”Ÿæˆ
./test.sh -r

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
./test.sh -h
```

### Pythonç›´æ¥å®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python run_compliance_tests.py

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ãå®Ÿè¡Œ
python run_compliance_tests.py --suite compliance --output-dir results

# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã®ã¿
python run_compliance_tests.py --report-only
```

### CI/CDçµ±åˆ

GitHub Actionsãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè‡ªå‹•å®Ÿè¡Œ:

- **ãƒˆãƒªã‚¬ãƒ¼**: `backend/**` ãƒ•ã‚©ãƒ«ãƒ€ã®å¤‰æ›´æ™‚
- **å®Ÿè¡Œç’°å¢ƒ**: Python 3.11, 3.12
- **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ**: ãƒ†ã‚¹ãƒˆçµæœã€HTMLãƒ¬ãƒãƒ¼ãƒˆ
- **å“è³ªã‚²ãƒ¼ãƒˆ**: 95%ä»¥ä¸Šã®æº–æ‹ ç‡ã§ãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èª

## å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«

### ãƒ†ã‚¹ãƒˆçµæœ

```
test_results/
â”œâ”€â”€ compliance-results.xml      # JUnitå½¢å¼ãƒ†ã‚¹ãƒˆçµæœ
â”œâ”€â”€ contracts-results.xml       # APIå¥‘ç´„ãƒ†ã‚¹ãƒˆçµæœ
â”œâ”€â”€ test_summary.json          # å®Ÿè¡Œã‚µãƒãƒªãƒ¼
â”œâ”€â”€ compliance_report.html     # HTMLæº–æ‹ æ€§ãƒ¬ãƒãƒ¼ãƒˆ
â””â”€â”€ compliance_report.json     # JSONæº–æ‹ æ€§ãƒ¬ãƒãƒ¼ãƒˆ
```

### ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹

- **ç·åˆæº–æ‹ åº¦**: å…¨ã‚«ãƒ†ã‚´ãƒªã®é‡ã¿ä»˜ãå¹³å‡
- **ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚³ã‚¢**: å„ãƒ†ã‚¹ãƒˆé ˜åŸŸã®è©³ç´°è©•ä¾¡
- **æ¨å¥¨äº‹é …**: æº–æ‹ æ€§å‘ä¸Šã®ãŸã‚ã®å…·ä½“çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- **å®Ÿè£…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å„è¦ä»¶ã®å®Ÿè£…çŠ¶æ³

## ãƒ†ã‚¹ãƒˆè¦ä»¶å®šç¾©

### YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

`tests/compliance/fixtures/design_requirements.yaml` ã§è¦ä»¶å®šç¾©:

```yaml
phase_pipeline:
  total_phases: 7
  required_phases:
    - phase_number: 1
      name: "ã‚³ãƒ³ã‚»ãƒ—ãƒˆãƒ»ä¸–ç•Œè¦³åˆ†æ"
      ai_model: "gemini-pro"
      timeout_seconds: 30

hitl_requirements:
  feedback_timeout_seconds: 30
  critical_phases: [4, 5, 7]
  feedback_types:
    - "natural_language"
    - "quick_options" 
    - "skip"

api_requirements:
  required_endpoints:
    - path: "/api/v1/manga/generate"
      method: "POST"
      response_status: 202
```

## ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### æ–°ã—ã„ãƒ†ã‚¹ãƒˆã®è¿½åŠ 

1. `tests/compliance/` ã«ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
2. `ComplianceTest` ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿
3. `design_requirements.yaml` ã«è¦ä»¶è¿½åŠ 
4. `__init__.py` ã«ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹è¿½åŠ 

### ãƒ¬ãƒãƒ¼ãƒˆè¨­å®šå¤‰æ›´

`app/tests/reports/compliance_reporter.py` ã§ä»¥ä¸‹ã‚’èª¿æ•´:

- é‡ã¿ä»˜ã‘ä¿‚æ•° (`CATEGORY_WEIGHTS`)
- åˆæ ¼åŸºæº– (`PASS_THRESHOLD`)
- æ¨å¥¨äº‹é …ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (`RECOMMENDATIONS`)

### CI/CDè¨­å®šèª¿æ•´

`.github/workflows/backend-compliance-tests.yml` ã§:

- å®Ÿè¡Œãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
- Pythonç‰ˆæœ¬ãƒãƒˆãƒªãƒƒã‚¯ã‚¹
- ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚²ãƒ¼ãƒˆåŸºæº–

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ä¸€èˆ¬çš„ãªå•é¡Œ

#### ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®å¯¾å‡¦

```bash
# è©³ç´°ãƒ­ã‚°ã§å•é¡Œç‰¹å®š
./test.sh -v -s compliance

# å€‹åˆ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
python -m pytest tests/compliance/test_design_requirements.py -v
```

#### ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼

```bash
# å¿…è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install pytest pytest-asyncio pyyaml jinja2

# è¦ä»¶ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ä¸€æ‹¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements-test.txt
```

#### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å•é¡Œ

- `design_requirements.yaml` ã®æ§‹æ–‡ç¢ºèª
- ãƒ‘ã‚¹ã®æ­£ç¢ºæ€§æ¤œè¨¼
- æ¨©é™å•é¡Œã®ç¢ºèª

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“çŸ­ç¸®

- ä¸¦åˆ—å®Ÿè¡Œ: `pytest -n auto`
- é¸æŠçš„å®Ÿè¡Œ: `pytest -m "not slow"`
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨: `pytest --cache-dir=.pytest_cache`

#### ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæœ€é©åŒ–

- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹åŒ–
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²å‡¦ç†
- éåŒæœŸãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

- æ©Ÿå¯†æƒ…å ±ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®é™¤å¤–
- èªè¨¼æƒ…å ±ã®ç’°å¢ƒå¤‰æ•°åŒ–
- ãƒ†ã‚¹ãƒˆçµæœã®é©åˆ‡ãªæ¨©é™ç®¡ç†
- CI/CDã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å®‰å…¨ãªç®¡ç†

## ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### å®šæœŸçš„ãªæ›´æ–°

- **æœˆæ¬¡**: ãƒ†ã‚¹ãƒˆè¦ä»¶ã®è¦‹ç›´ã—
- **ãƒªãƒªãƒ¼ã‚¹æ¯**: è¨­è¨ˆæ›¸ã¨ã®åŒæœŸ
- **å››åŠæœŸ**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡
- **å¹´æ¬¡**: ãƒ†ã‚¹ãƒˆæˆ¦ç•¥å…¨ä½“è¦‹ç›´ã—

### è¨­è¨ˆæ›¸å¤‰æ›´æ™‚ã®å¯¾å¿œ

1. `design_requirements.yaml` æ›´æ–°
2. é–¢é€£ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¿®æ­£
3. ãƒ¬ãƒãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª¿æ•´
4. CI/CDè¨­å®šè¦‹ç›´ã—

## å‚è€ƒè³‡æ–™

- [è¨­è¨ˆæ›¸](../docs/05.APIè¨­è¨ˆæ›¸.md)
- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](../docs/04.ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸.md) 
- [AIè¨­è¨ˆä»•æ§˜](../docs/08.AIè¨­è¨ˆæ›¸.md)
- [pytest Documentation](https://docs.pytest.org/)
- [GitHub Actions Guide](https://docs.github.com/actions)