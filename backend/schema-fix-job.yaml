steps:
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Run the schema fix SQL directly
        echo "Running database schema fix..."
        gcloud sql connect manga-db-prod --user=postgres --database=manga_db --quiet << 'EOF'
        -- Fix missing request_id column in manga_sessions table
        DO $$
        BEGIN
            IF NOT EXISTS (
                SELECT 1
                FROM information_schema.columns
                WHERE table_name = 'manga_sessions'
                AND column_name = 'request_id'
            ) THEN
                -- Add the request_id column
                ALTER TABLE manga_sessions
                ADD COLUMN request_id UUID UNIQUE DEFAULT gen_random_uuid();

                -- Update existing records to have request_id values
                UPDATE manga_sessions
                SET request_id = gen_random_uuid()
                WHERE request_id IS NULL;

                RAISE NOTICE 'Added request_id column to manga_sessions table';
            ELSE
                RAISE NOTICE 'request_id column already exists in manga_sessions table';
            END IF;

            -- Check if other columns exist and add them if missing
            IF NOT EXISTS (
                SELECT 1
                FROM information_schema.columns
                WHERE table_name = 'manga_sessions'
                AND column_name = 'session_metadata'
            ) THEN
                ALTER TABLE manga_sessions
                ADD COLUMN session_metadata JSON;
                RAISE NOTICE 'Added session_metadata column';
            END IF;

            IF NOT EXISTS (
                SELECT 1
                FROM information_schema.columns
                WHERE table_name = 'manga_sessions'
                AND column_name = 'current_phase'
            ) THEN
                ALTER TABLE manga_sessions
                ADD COLUMN current_phase INTEGER DEFAULT 0;
                RAISE NOTICE 'Added current_phase column';
            END IF;

            IF NOT EXISTS (
                SELECT 1
                FROM information_schema.columns
                WHERE table_name = 'manga_sessions'
                AND column_name = 'total_phases'
            ) THEN
                ALTER TABLE manga_sessions
                ADD COLUMN total_phases INTEGER DEFAULT 5;
                RAISE NOTICE 'Added total_phases column';
            END IF;
        END $$;

        -- Verify the columns exist
        SELECT column_name, data_type, is_nullable
        FROM information_schema.columns
        WHERE table_name = 'manga_sessions'
        AND column_name IN ('request_id', 'session_metadata', 'current_phase', 'total_phases')
        ORDER BY column_name;
        EOF
        echo "Schema fix completed"

options:
  logging: CLOUD_LOGGING_ONLY