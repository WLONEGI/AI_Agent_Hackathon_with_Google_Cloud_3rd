# AIæ¼«ç”»ç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹ ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆæ›¸

**æ–‡æ›¸ç®¡ç†æƒ…å ±**
- æ–‡æ›¸ID: INF-DOC-001
- ä½œæˆæ—¥: 2025-01-20
- ç‰ˆæ•°: 2.0
- æ‰¿èªè€…: æ ¹å²¸ç¥æ¨¹
- é–¢é€£æ–‡æ›¸: SYS-DOC-001ï¼ˆã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸ï¼‰ã€REQ-DOC-001ï¼ˆè¦ä»¶å®šç¾©æ›¸ï¼‰
- æ›´æ–°å±¥æ­´:
  - v1.0: åŸºæœ¬ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆå®Œæˆ
  - v2.0: é–‹ç™ºç’°å¢ƒè¨­è¨ˆçµ±åˆ (Development_Setup_Guide.mdçµ±åˆ)

## ç›®æ¬¡

- [1. ã‚¤ãƒ³ãƒ•ãƒ©æ¦‚è¦](#1-ã‚¤ãƒ³ãƒ•ãƒ©æ¦‚è¦)
  - [1.1 è¨­è¨ˆæ–¹é‡](#11-è¨­è¨ˆæ–¹é‡)
  - [1.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦](#12-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦)
- [2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­è¨ˆ](#2-ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­è¨ˆ)
  - [2.1 VPCæ§‹æˆ](#21-vpcæ§‹æˆ)
  - [2.2 ã‚µãƒ–ãƒãƒƒãƒˆè¨­è¨ˆ](#22-ã‚µãƒ–ãƒãƒƒãƒˆè¨­è¨ˆ)
  - [2.3 ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š](#23-ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š)
- [3. ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­è¨ˆ](#3-ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­è¨ˆ)
  - [3.1 Cloud Runæ§‹æˆ](#31-cloud-runæ§‹æˆ)
  - [3.2 ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­è¨ˆ](#32-ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­è¨ˆ)
  - [3.3 ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­è¨ˆ](#33-ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­è¨ˆ)
- [4. ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆ](#4-ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆ)
  - [4.1 Cloud SQLè¨­è¨ˆ](#41-cloud-sqlè¨­è¨ˆ)
  - [4.2 Rediså˜ä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­è¨ˆ](#42-rediså˜ä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­è¨ˆ)
  - [4.3 Cloud Storageè¨­è¨ˆ](#43-cloud-storageè¨­è¨ˆ)
- [5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ](#5-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ)
  - [5.1 IAMè¨­è¨ˆ](#51-iamè¨­è¨ˆ)
  - [5.2 Secret Manager](#52-secret-manager)
  - [5.3 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#53-ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
- [6. CI/CDè¨­è¨ˆ](#6-cicdè¨­è¨ˆ)
  - [6.1 Cloud Buildè¨­å®š](#61-cloud-buildè¨­å®š)
  - [6.2 ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥](#62-ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥)
  - [6.3 ç’°å¢ƒç®¡ç†](#63-ç’°å¢ƒç®¡ç†)
- [7. é–‹ç™ºç’°å¢ƒè¨­è¨ˆ](#7-é–‹ç™ºç’°å¢ƒè¨­è¨ˆ)
  - [7.1 é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](#71-é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)
  - [7.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºç’°å¢ƒ](#72-ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºç’°å¢ƒ)
  - [7.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºç’°å¢ƒ](#73-ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºç’°å¢ƒ)
  - [7.4 çµ±åˆé–‹ç™ºç’°å¢ƒ](#74-çµ±åˆé–‹ç™ºç’°å¢ƒ)
  - [7.5 é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼](#75-é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼)
  - [7.6 ç›£è¦–ãƒ»ãƒ‡ãƒãƒƒã‚°](#76-ç›£è¦–ãƒ‡ãƒãƒƒã‚°)
  - [7.7 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#77-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
  - [7.8 ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³é€£æº](#78-ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³é€£æº)
  - [7.9 é–‹ç™ºç’°å¢ƒãƒªã‚½ãƒ¼ã‚¹](#79-é–‹ç™ºç’°å¢ƒãƒªã‚½ãƒ¼ã‚¹)

---

## 1. ã‚¤ãƒ³ãƒ•ãƒ©æ¦‚è¦

### 1.1 è¨­è¨ˆæ–¹é‡

| æ–¹é‡ | å†…å®¹ | ç†ç”± |
|------|------|------|
| ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—æœ€é©åŒ– | è»½é‡æ§‹æˆã§ã‚¹ã‚¿ãƒ¼ãƒˆã€æ®µéšçš„æ‹¡å¼µ | åˆæœŸã‚³ã‚¹ãƒˆæŠ‘åˆ¶ã€è¿…é€ŸãªMVPå±•é–‹ |
| Google Cloud ãƒã‚¤ãƒ†ã‚£ãƒ– | GCPæ¨™æº–ã‚µãƒ¼ãƒ“ã‚¹æ´»ç”¨ | é‹ç”¨è² è·å‰Šæ¸›ã€çµ±åˆç®¡ç† |
| ã‚·ãƒ³ãƒ—ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | å˜ä¸€VPCã€å¿…è¦æœ€å°é™ã®åˆ†é›¢ | è¤‡é›‘æ€§æ’é™¤ã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç°¡ç´ åŒ– |
| ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰å„ªå…ˆ | Cloud SQLã€Memory Storeæ´»ç”¨ | é‹ç”¨å·¥æ•°å‰Šæ¸›ã€è‡ªå‹•åŒ–æ¨é€² |

### 1.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```mermaid
graph TB
    subgraph "Internet"
        U[Users]
    end
    
    subgraph "Google Cloud Platform"
        subgraph "Load Balancer"
            LB[Cloud Load Balancer]
            CDN[Cloud CDN]
        end
        
        subgraph "VPC: manga-service-vpc (10.0.0.0/16)"
            subgraph "Public Subnet (10.0.1.0/24)"
                CR[Cloud Run Services]
            end
            
            subgraph "Private Subnet (10.0.2.0/24)"
                DB[Cloud SQL PostgreSQL]
                RD[Memory Store Redis]
            end
        end
        
        subgraph "Storage"
            CS[Cloud Storage]
        end
        
        subgraph "External APIs"
            GM[Gemini Pro]
            IM[Imagen 4]
        end
        
        subgraph "Monitoring"
            MON[Cloud Monitoring]
            LOG[Cloud Logging]
        end
    end
    
    U --> LB
    LB --> CDN
    CDN --> CR
    CR --> DB
    CR --> RD
    CR --> CS
    CR --> GM
    CR --> IM
    CR --> MON
    CR --> LOG
```

---

## 2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­è¨ˆ

### 2.1 VPCæ§‹æˆ

#### åŸºæœ¬è¨­å®š
```yaml
VPC Configuration:
  Name: manga-service-vpc
  Region: asia-northeast1 (Tokyo)
  IP Range: 10.0.0.0/16
  Route Mode: Regional
  DNS Policy: Default
```

#### Terraformè¨­å®šä¾‹
```hcl
resource "google_compute_network" "manga_vpc" {
  name                    = "manga-service-vpc"
  auto_create_subnetworks = false
  mtu                     = 1460
}

resource "google_compute_router" "manga_router" {
  name    = "manga-router"
  region  = var.region
  network = google_compute_network.manga_vpc.id
}

resource "google_compute_router_nat" "manga_nat" {
  name                               = "manga-nat"
  router                             = google_compute_router.manga_router.name
  region                             = var.region
  nat_ip_allocate_option             = "AUTO_ONLY"
  source_subnetwork_ip_ranges_to_nat = "ALL_SUBNETWORKS_ALL_IP_RANGES"
}
```

### 2.2 ã‚µãƒ–ãƒãƒƒãƒˆè¨­è¨ˆ

#### ã‚µãƒ–ãƒãƒƒãƒˆæ§‹æˆ
| ã‚µãƒ–ãƒãƒƒãƒˆå | CIDR | ç”¨é€” | ã‚¢ã‚¯ã‚»ã‚¹ |
|-------------|------|------|---------|
| manga-public | 10.0.1.0/24 | Cloud Run Connector | Public |
| manga-private | 10.0.2.0/24 | Cloud SQL, Redis | Private |
| manga-management | 10.0.3.0/24 | ç®¡ç†ãƒ»ç›£è¦– | Private |

#### Terraformè¨­å®š
```hcl
# ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆï¼ˆCloud Runç”¨ï¼‰
resource "google_compute_subnetwork" "manga_public" {
  name          = "manga-public"
  ip_cidr_range = "10.0.1.0/24"
  region        = var.region
  network       = google_compute_network.manga_vpc.id
}

# ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç”¨ï¼‰
resource "google_compute_subnetwork" "manga_private" {
  name          = "manga-private"
  ip_cidr_range = "10.0.2.0/24"
  region        = var.region
  network       = google_compute_network.manga_vpc.id
  
  private_ip_google_access = true
  
  secondary_ip_range {
    range_name    = "manga-pods"
    ip_cidr_range = "10.1.0.0/16"
  }
}
```

### 2.3 ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®š

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
```hcl
# HTTPSæµå…¥è¨±å¯
resource "google_compute_firewall" "allow_https" {
  name    = "manga-allow-https"
  network = google_compute_network.manga_vpc.name

  allow {
    protocol = "tcp"
    ports    = ["443"]
  }

  source_ranges = ["0.0.0.0/0"]
  target_tags   = ["https-server"]
}

# VPCå†…éƒ¨é€šä¿¡è¨±å¯
resource "google_compute_firewall" "allow_internal" {
  name    = "manga-allow-internal"
  network = google_compute_network.manga_vpc.name

  allow {
    protocol = "tcp"
    ports    = ["0-65535"]
  }

  allow {
    protocol = "udp"
    ports    = ["0-65535"]
  }

  source_ranges = ["10.0.0.0/16"]
}

# Health Checkè¨±å¯
resource "google_compute_firewall" "allow_health_check" {
  name    = "manga-allow-health-check"
  network = google_compute_network.manga_vpc.name

  allow {
    protocol = "tcp"
    ports    = ["8080"]
  }

  source_ranges = ["130.211.0.0/22", "35.191.0.0/16"]
  target_tags   = ["cloud-run-service"]
}
```

### 2.4 Direct VPC Egressè¨­å®š

#### Cloud Run VPCæ¥ç¶š
```yaml
# Direct VPC Egressä½¿ç”¨ï¼ˆVPC Connectorä¸è¦ãƒ»ã‚³ã‚¹ãƒˆ$0ï¼‰
Network Configuration:
  Connection Type: Direct VPC Egress
  VPC Network: manga-service-vpc
  Subnet: manga-private (10.0.2.0/24)
  Benefits:
    - VPC Connectorä¸è¦ï¼ˆæœˆé¡$20-40å‰Šæ¸›ï¼‰
    - é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆç›´æ¥VPCæ¥ç¶šï¼‰
    - ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­å®š
```

#### Terraformè¨­å®šä¾‹
```hcl
# Direct VPC Egressç”¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
resource "google_compute_route" "manga_private_route" {
  name             = "manga-private-route"
  dest_range       = "0.0.0.0/0"
  network          = google_compute_network.manga_vpc.name
  next_hop_gateway = "default-internet-gateway"
  priority         = 1000
  
  # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã‹ã‚‰ã®å¤–å‘ãé€šä¿¡ç”¨
  tags = ["cloud-run-egress"]
}

# Cloud Runç”¨IAMæ¨©é™
resource "google_project_iam_member" "run_network_admin" {
  project = var.project_id
  role    = "roles/run.networkAdmin"
  member  = "serviceAccount:${google_service_account.manga_service.email}"
}
```

---

## 3. ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­è¨ˆ

### 3.1 Cloud Runæ§‹æˆ

#### è»½é‡åŒ–æ§‹æˆè¨­å®šï¼ˆDirect VPC Egressä½¿ç”¨ï¼‰
```yaml
# Phase 1-7 å…±é€šè¨­å®šï¼ˆæ–°ãƒ•ãƒ­ãƒ¼ç‰ˆ + Direct VPC Egressï¼‰
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: phase-service-template
  annotations:
    run.googleapis.com/ingress: internal-and-cloud-load-balancing
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/cpu: "1"
        run.googleapis.com/memory: "2Gi"
        run.googleapis.com/execution-environment: gen2
        # Direct VPC Egressä½¿ç”¨ï¼ˆVPC Connectorä¸è¦ï¼‰
        run.googleapis.com/network-interfaces: '[{"network":"manga-service-vpc","subnetwork":"manga-private"}]'
        run.googleapis.com/cloudsql-instances: manga-db-instance
    spec:
      containerConcurrency: 50  # è»½é‡åŒ–ã®ãŸã‚å‰Šæ¸›
      timeoutSeconds: 300       # 5åˆ†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      serviceAccountName: manga-service-account
      containers:
      - image: gcr.io/PROJECT_ID/phase-service:latest
        ports:
        - containerPort: 8080
        resources:
          limits:
            cpu: "1"
            memory: "2Gi"
        env:
        - name: REDIS_HOST
          value: "10.0.2.10"
        - name: DB_HOST
          value: "10.0.2.5"
```

#### ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
```yaml
# Phase 5(ã‚·ãƒ¼ãƒ³ç”»åƒç”Ÿæˆ)ã®ã¿ãƒªã‚½ãƒ¼ã‚¹å¢—å¼·
Phase5_Overrides:
  cpu: "2"           # Imagenä½µç”¨ã®ãŸã‚2å€
  memory: "4Gi"      # ãƒ¡ãƒ¢ãƒªã‚‚2å€
  timeout: 60        # 40ç§’+ãƒãƒƒãƒ•ã‚¡
  concurrency: 5     # ä¸¦åˆ—å‡¦ç†æ•°åˆ¶é™

# Phase 2(ã‚­ãƒ£ãƒ©ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ç”Ÿæˆ)ã®è¨­å®š
Phase2_Overrides:
  cpu: "1.5"         # ç°¡æ˜“ç”»åƒç”Ÿæˆç”¨
  memory: "3Gi"      # ãƒ¡ãƒ¢ãƒªå°‘ã—å¢—å¼·
  timeout: 20        # 12ç§’+ãƒãƒƒãƒ•ã‚¡
```

### 3.2 ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­è¨ˆ

#### ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­å®š
| é …ç›® | è¨­å®šå€¤ | èª¬æ˜ |
|------|--------|------|
| æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ | 1 | ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­– |
| æœ€å¤§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ | 50 | ãƒ”ãƒ¼ã‚¯æ™‚å¯¾å¿œ |
| CPUé–¾å€¤ | 80% | ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆãƒˆãƒªã‚¬ãƒ¼ |
| ãƒ¡ãƒ¢ãƒªé–¾å€¤ | 70% | ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆãƒˆãƒªã‚¬ãƒ¼ |
| ã‚¹ã‚±ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³é…å»¶ | 300ç§’ | é »ç¹ãªã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°é˜²æ­¢ |

```yaml
Scaling Configuration:
  Min Instances: 1     # ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­–
  Max Instances: 50    # çµ±åˆã‚µãƒ¼ãƒ“ã‚¹ã®ãŸã‚ä¸Šé™å¼•ãä¸Šã’
  Target CPU: 80%      # åŠ¹ç‡çš„ãªãƒªã‚½ãƒ¼ã‚¹åˆ©ç”¨
  Target Memory: 70%   # ãƒ¡ãƒ¢ãƒªåŠ¹ç‡é‡è¦–
  Scale Down Delay: 300s  # 5åˆ†é–“ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
```

### 3.3 ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­è¨ˆ

#### IAM ãƒ­ãƒ¼ãƒ«è¨­è¨ˆ
```yaml
Service Accounts:
  manga-service-account:
    roles:
      - roles/cloudsql.client
      - roles/redis.editor
      - roles/storage.objectAdmin
      - roles/logging.logWriter
      - roles/monitoring.metricWriter
      - roles/secretmanager.secretAccessor

  manga-cicd-account:
    roles:
      - roles/run.developer
      - roles/storage.admin
      - roles/cloudbuild.builds.editor
      - roles/iam.serviceAccountUser
```

---

## 4. ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆ

### 4.1 Cloud SQLè¨­è¨ˆ

#### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®šï¼ˆè»½é‡ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ç‰ˆï¼‰
```yaml
Cloud SQL Configuration:
  Instance ID: manga-db-instance
  Database Version: PostgreSQL 15
  Region: asia-northeast1
  Zone: asia-northeast1-a
  
  Machine Type: db-standard-1  # ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—å‘ã‘è»½é‡ç‰ˆ
  CPU: 1 vCPU
  Memory: 3.75 GB
  Storage: 100 GB SSD (Auto-increase enabled)
  
  Network:
    Private IP: 10.0.2.5
    Authorized Networks: VPC manga-service-vpc
    SSL: Required
  
  Backup:
    Automated Backup: Enabled
    Backup Window: 03:00-04:00 JST
    Point-in-time Recovery: 7 days
    Retention: 30 days
  
  Maintenance:
    Window: Sunday 04:00-05:00 JST
    Update Strategy: OPPORTUNISTIC
```

#### Terraformè¨­å®š
```hcl
resource "google_sql_database_instance" "manga_db" {
  name             = "manga-db-instance"
  database_version = "POSTGRES_15"
  region           = var.region

  settings {
    tier = "db-standard-1"  # è»½é‡ç‰ˆ
    
    disk_type    = "PD_SSD"
    disk_size    = 100
    disk_autoresize       = true
    disk_autoresize_limit = 500  # æœ€å¤§500GB

    backup_configuration {
      enabled                        = true
      start_time                     = "03:00"
      point_in_time_recovery_enabled = true
      backup_retention_settings {
        retained_backups = 30
      }
    }

    ip_configuration {
      ipv4_enabled    = false
      private_network = google_compute_network.manga_vpc.id
      require_ssl     = true
    }

    maintenance_window {
      day  = 7  # Sunday
      hour = 4
    }
  }

  deletion_protection = true
}
```

### 4.2 Rediså˜ä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­è¨ˆ

#### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¨­å®š
```yaml
Redis Configuration:
  Service: Memory Store for Redis
  Version: Redis 7.0
  Tier: Basic
  Memory: 4GB
  Region: asia-northeast1
  Network: manga-service-vpc
  IP: 10.0.2.10
  
  Estimated Cost: $120/month
  
  Performance:
    - æœ€å¤§æ¥ç¶šæ•°: 65,000
    - ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ: 250,000 ops/sec
    - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼: <1ms
```

#### Redisæ¥ç¶šè¨­å®š
```python
import redis
import os

class RedisManager:
    def __init__(self):
        self.client = redis.Redis(
            host=os.getenv('REDIS_HOST', '10.0.2.10'),
            port=6379,
            decode_responses=True,
            socket_connect_timeout=5,
            retry_on_timeout=True,
            health_check_interval=30
        )
    
    async def get_connection_pool(self):
        """æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®š"""
        return redis.ConnectionPool(
            host=os.getenv('REDIS_HOST', '10.0.2.10'),
            port=6379,
            max_connections=50,
            decode_responses=True
        )

#### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã«ä¼´ã†Redisä½¿ç”¨é‡å‰Šæ¸›

**å¤‰æ›´æ–¹é‡**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’CDN+Cloud Storageã«ç§»è¡Œ
```yaml
Redis Usage Reduction Strategy:
  Before (Redisä¾å­˜):
    - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ~2GB
    - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹: ~500MB  
    - ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´: ~1GB
    Total Redis Usage: ~4GB
    
  After (CDNæœ€é©åŒ–):
    - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿: Cloud Storage + CDN
    - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹: Cloud Storage + CDN  
    - ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´: Cloud Storage
    Remaining Redis Usage: ~1GB (ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®ã¿)
    
  Benefits:
    - Redisè²»ç”¨: $120/æœˆ â†’ $30/æœˆ (75%å‰Šæ¸›)
    - ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
    - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼æ”¹å–„ (CDNåŠ¹æœ)
    - ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šæ€§å‘ä¸Š
```

**Redisæ–°æ§‹æˆ**:
```yaml
Redis Optimized Configuration:
  Service: Memory Store for Redis  
  Version: Redis 7.0
  Tier: Basic
  Memory: 1GB (4GBã‹ã‚‰å‰Šæ¸›)
  Region: asia-northeast1
  
  New Estimated Cost: $30/month (90$å‰Šæ¸›)
  
  Primary Usage:
    - WebSocketã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
    - API ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚«ã‚¦ãƒ³ã‚¿
    - ä¸€æ™‚çš„ãªå‡¦ç†çŠ¶æ…‹
    - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã‚­ãƒ¥ãƒ¼
```

### 4.3 Cloud Storageè¨­è¨ˆ

#### ãƒã‚±ãƒƒãƒˆæ§‹æˆï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œç‰ˆï¼‰
```yaml
Storage Buckets:
  manga-input-data:
    Location: asia-northeast1
    Storage Class: Standard
    Lifecycle:
      - Delete objects older than 90 days
    
  manga-output-images:
    Location: asia-northeast1
    Storage Class: Standard
    Public Access: Enabled (CDNç”¨)
    CORS: Enabled
    
  manga-preview-cache:
    Location: asia-northeast1
    Storage Class: Standard
    Public Access: Enabled (CDNç”¨)
    Purpose: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ»ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    CDN: Cloud CDN with optimized caching
    Cache Headers:
      - Images: "public, max-age=604800, immutable"
      - Metadata: "public, max-age=1800" 
      - Interactive: "public, max-age=86400"
    CORS: Enabled for interactive content
    Lifecycle:
      - Delete objects older than 30 days
    
  manga-version-snapshots:
    Location: asia-northeast1  
    Storage Class: Standard
    Purpose: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ãƒ»æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿
    Lifecycle:
      - Transition to Nearline after 7 days
      - Delete objects older than 60 days
    
  manga-final-products:
    Location: asia-northeast1
    Storage Class: Standard
    Lifecycle:
      - Transition to Nearline after 30 days
      - Transition to Coldline after 365 days
    
  manga-temp-data:
    Location: asia-northeast1
    Storage Class: Standard
    Lifecycle:
      - Delete objects older than 7 days
```

#### Terraformè¨­å®š
```hcl
# å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ç”¨ãƒã‚±ãƒƒãƒˆ
resource "google_storage_bucket" "input_data" {
  name     = "${var.project_id}-manga-input-data"
  location = var.region

  lifecycle_rule {
    condition {
      age = 90
    }
    action {
      type = "Delete"
    }
  }

  versioning {
    enabled = true
  }

  encryption {
    default_kms_key_name = google_kms_crypto_key.storage_key.id
  }
}

# å‡ºåŠ›ç”»åƒç”¨ãƒã‚±ãƒƒãƒˆï¼ˆCDNå¯¾å¿œï¼‰
resource "google_storage_bucket" "output_images" {
  name     = "${var.project_id}-manga-output-images"
  location = var.region

  cors {
    origin          = ["https://*.manga-service.com"]
    method          = ["GET", "HEAD"]
    response_header = ["*"]
    max_age_seconds = 3600
  }

  uniform_bucket_level_access = true
}

# ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ãƒã‚±ãƒƒãƒˆï¼ˆCDNæœ€é©åŒ–ï¼‰
resource "google_storage_bucket" "preview_cache" {
  name     = "${var.project_id}-manga-preview-cache"
  location = var.region

  cors {
    origin          = ["https://*.manga-service.com", "https://localhost:*"]
    method          = ["GET", "HEAD", "PUT", "POST"]
    response_header = ["*"]
    max_age_seconds = 3600
  }

  lifecycle_rule {
    condition {
      age = 30
    }
    action {
      type = "Delete"
    }
  }

  uniform_bucket_level_access = true
}

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆç”¨ãƒã‚±ãƒƒãƒˆ  
resource "google_storage_bucket" "version_snapshots" {
  name     = "${var.project_id}-manga-version-snapshots"
  location = var.region

  lifecycle_rule {
    condition {
      age = 7
    }
    action {
      type = "SetStorageClass"
      storage_class = "NEARLINE"
    }
  }

  lifecycle_rule {
    condition {
      age = 60  
    }
    action {
      type = "Delete"
    }
  }

  versioning {
    enabled = true
  }
}

# ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ç”¨ãƒã‚±ãƒƒãƒˆ
resource "google_storage_bucket" "temp_data" {
  name     = "${var.project_id}-manga-temp-data"
  location = var.region

  lifecycle_rule {
    condition {
      age = 7
    }
    action {
      type = "Delete"
    }
  }
}
```

---

## 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 5.1 IAMè¨­è¨ˆ

#### æœ€å°æ¨©é™ã®åŸå‰‡
```yaml
Service Account Roles:

  manga-cicd-sa:
    - roles/run.developer
    - roles/cloudbuild.builds.editor
    - roles/storage.admin
    - roles/iam.serviceAccountUser
```

### 5.2 Secret Manager

#### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†
```yaml
Secrets Configuration:
  manga-secret-key:
    Description: "Application JWT Secret Key"
    Replication: automatic
    Access: manga-service-account
    Status: âœ… Implemented
    Usage: Cloud Run environment variable
    
  manga-database-url:
    Description: "PostgreSQL Connection URL"
    Replication: automatic  
    Access: manga-service-account
    Status: âœ… Implemented
    Usage: Cloud Run environment variable
    
  gemini-api-key:
    Description: "Google Gemini Pro API Key"
    Replication: automatic
    Access: manga-service-account
    Status: â³ Planned
    
  imagen-api-key:
    Description: "Google Imagen 4 API Key"
    Replication: automatic
    Access: manga-service-account
    Status: â³ Planned
    
  firebase-credentials:
    Description: "Firebase Service Account Credentials"
    Replication: automatic
    Access: manga-service-account
    Status: â³ Planned
```

#### Terraformè¨­å®š
```hcl
resource "google_secret_manager_secret" "gemini_api_key" {
  secret_id = "gemini-api-key"

  replication {
    automatic = true
  }
}

resource "google_secret_manager_secret_iam_binding" "gemini_access" {
  project   = var.project_id
  secret_id = google_secret_manager_secret.gemini_api_key.secret_id
  role      = "roles/secretmanager.secretAccessor"

  members = [
    "serviceAccount:${google_service_account.manga_service.email}",
  ]
}
```

### 5.3 HITL (Human-in-the-Loop) ã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆ

#### WebSocket Infrastructure
```yaml
Cloud Run WebSocket Configuration:
  WebSocket Support: Enabled
  Connection Timeout: 30 minutes
  Max Concurrent Connections: 1000
  
  Environment Variables:
    WEBSOCKET_ENABLED: "true"
    HITL_TIMEOUT_SECONDS: "30"
    MAX_FEEDBACK_WAIT_TIME: "1800"  # 30 minutes
    
  Health Check:
    Path: /ws/health
    Interval: 30s
    Timeout: 5s
```

#### Session Management Infrastructure
```yaml
Redis Session Configuration:
  Purpose: HITL session storage
  TTL: 3600 seconds (1 hour)
  Memory Allocation: 2GB
  
  Session Data Structure:
    session:{request_id}:
      - user_id: string
      - current_phase: integer
      - feedback_timeout: timestamp
      - session_start: timestamp
      - phase_results: json
      
  Pub/Sub Channels:
    hitl_feedback:{request_id}: Real-time feedback
    phase_progress:{request_id}: Phase completion updates
    session_timeout:{request_id}: Timeout notifications
```

#### Feedback Queue Management
```yaml
Cloud Pub/Sub Configuration:
  Topics:
    - hitl-feedback-topic
    - phase-completion-topic  
    - session-management-topic
    
  Subscriptions:
    - hitl-feedback-processor
    - phase-transition-handler
    - session-cleanup-service
    
  Dead Letter Queue:
    Max Delivery Attempts: 5
    Dead Letter Topic: hitl-feedback-dlq
    Retention Period: 7 days
```

#### HITL Monitoring Infrastructure
```yaml
Cloud Monitoring Metrics:
  Custom Metrics:
    - hitl/session_duration
    - hitl/feedback_timeout_rate
    - hitl/user_engagement_score
    - hitl/phase_completion_time
    - hitl/retry_rate_per_phase
    
  Alerting Policies:
    High Timeout Rate:
      Condition: hitl/feedback_timeout_rate > 0.3
      Notification: Email + Slack
      
    Session Duration Alert:
      Condition: hitl/session_duration > 30 minutes
      Action: Auto-cleanup trigger
      
  Dashboards:
    - HITL Performance Overview
    - User Engagement Analytics  
    - Phase-wise Quality Metrics
```

#### Chat Infrastructure
```yaml
Chat Service Configuration:
  Service: Cloud Run (chat-service)
  Instances: 
    Min: 2
    Max: 100
  CPU: 2
  Memory: 4Gi
  
  WebSocket Settings:
    Max Message Size: 10KB
    Ping Interval: 30s
    Pong Timeout: 10s
    Compression: Enabled
    
  Chat Database (Firestore):
    Collections:
      chat_sessions:
        - session_id: string
        - request_id: string
        - user_id: string
        - created_at: timestamp
        - last_activity: timestamp
        
      chat_messages:
        - message_id: string
        - session_id: string
        - phase: integer
        - content: string
        - message_type: enum(text|quick_action|system)
        - created_at: timestamp
        - processed: boolean
        
      chat_intents:
        - intent_id: string
        - message_id: string
        - parsed_intent: json
        - confidence_score: float
        - applied: boolean
```

#### Chat Message Processing Pipeline
```yaml
Message Processing Infrastructure:
  Gemini Pro Integration:
    Model: gemini-pro
    Purpose: Natural language understanding
    Rate Limit: 60 requests/minute
    
    Processing Flow:
      1. Message received via WebSocket
      2. Store in Firestore
      3. Send to Gemini Pro for intent parsing
      4. Store parsed intent
      5. Apply feedback to phase data
      6. Send confirmation via WebSocket
      
  Redis Cache for Chat:
    Purpose: Real-time message caching
    Structure:
      chat:{session_id}:messages: List of recent messages
      chat:{session_id}:typing: Typing indicators
      chat:{session_id}:online: Online status
    TTL: 1 hour after last activity
    
  Cloud Functions for Chat:
    process-chat-message:
      Trigger: Firestore onCreate (chat_messages)
      Runtime: Python 3.11
      Memory: 512MB
      Timeout: 60s
      
    cleanup-chat-sessions:
      Trigger: Cloud Scheduler (every hour)
      Purpose: Clean inactive sessions
      
    aggregate-chat-analytics:
      Trigger: Cloud Scheduler (daily)
      Purpose: Analyze chat patterns
```

#### Real-time Notification Infrastructure
```yaml
Notification System:
  Cloud Tasks for Async Processing:
    Queues:
      - chat-notification-queue
      - feedback-processing-queue
      - preview-generation-queue
      
    Configuration:
      Max Concurrent Dispatches: 100
      Max Retry Attempts: 3
      Rate Limits: 500/s
      
  Firebase Cloud Messaging (Optional):
    Purpose: Mobile/Web push notifications
    Topics:
      - phase_complete
      - feedback_timeout_warning
      - generation_complete
```

#### Quality Gate Infrastructure  
```yaml
BigQuery Analytics:
  Dataset: manga_quality_analytics
  Tables:
    - phase_quality_scores
    - user_feedback_analysis
    - retry_patterns
    - quality_trends
    - chat_interaction_metrics
    
  Scheduled Queries:
    - Daily quality reports
    - Weekly trend analysis
    - Chat engagement metrics
    - Monthly performance review
    
  Data Export:
    Format: JSON
    Schedule: Real-time streaming
    Destination: Cloud Storage bucket
```

### 5.4 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

#### VPCã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
```yaml
Security Configuration:
  Private Google Access: Enabled
  Private Service Connect: Enabled for Google APIs
  
  Firewall Priority:
    1. Deny All (Priority: 65534)
    2. Allow HTTPS (Priority: 1000)
    3. Allow Internal VPC (Priority: 1001)
    4. Allow Health Check (Priority: 1002)
  
  DDoS Protection: 
    Cloud Armor: Basic (free tier)
    Rate Limiting: 1000 req/min per IP
```

---


---

## 6. CI/CDè¨­è¨ˆ

### 6.1 Cloud Buildè¨­å®š

#### ãƒ“ãƒ«ãƒ‰ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
```yaml
# cloudbuild.yaml
steps:
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  - name: 'python:3.11'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install -r requirements.txt
        pytest tests/ --cov=./ --cov-report=xml
    
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud components install local-extract
        gcloud beta code security-analysis scan ./
    
  # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆçµ±åˆã‚µãƒ¼ãƒ“ã‚¹ï¼‰
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/manga-generation:${SHORT_SHA}'
      - '-t'
      - 'gcr.io/$PROJECT_ID/manga-generation:latest'
      - '.'
    
  # ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/manga-generation:${SHORT_SHA}'
    
  # Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud run deploy manga-generation-service \
          --image gcr.io/$PROJECT_ID/manga-generation:${SHORT_SHA} \
          --region asia-northeast1 \
          --platform managed \
          --cpu 8 \
          --memory 32Gi \
          --timeout 600 \
          --min-instances 1 \
          --max-instances 50 \
          --no-allow-unauthenticated

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'  # ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–
```

### 6.2 ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥

#### ç’°å¢ƒåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼
```mermaid
flowchart LR
    A[GitHub Push] --> B[Cloud Build Trigger]
    B --> C{Branch Check}
    C -->|feature/*| D[Development Deploy]
    C -->|main| E[Staging Deploy]
    E --> F[Integration Tests]
    F -->|Pass| G[Production Deploy]
    F -->|Fail| H[Rollback]
    G --> I[Health Check]
    I -->|Fail| H
    
    subgraph "Deployment Strategy"
        J[Blue-Green Deploy]
        K[Traffic Splitting]
        L[Gradual Rollout]
    end
    
    G --> J
    J --> K
    K --> L
```

#### æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ
```yaml
Deployment Strategy:
  Development:
    Trigger: feature/* branch push
    Target: dev-phase*-service
    Traffic: 100%
    
  Staging:
    Trigger: main branch push
    Target: staging-phase*-service
    Testing: Automated integration tests
    
  Production:
    Trigger: Manual approval after staging
    Strategy: Blue-Green with traffic splitting
    Rollout:
      - Phase 1: 10% traffic for 10 minutes
      - Phase 2: 50% traffic for 30 minutes  
      - Phase 3: 100% traffic
    Rollback: Automatic if error rate > 1%
```

### 6.3 ç’°å¢ƒç®¡ç†

#### ç’°å¢ƒå¤‰æ•°ç®¡ç†
```yaml
Environment Variables:
  Development:
    ENVIRONMENT: dev
    LOG_LEVEL: DEBUG
    REDIS_HOST: dev-redis-host
    DB_HOST: dev-db-host
    
  Staging:
    ENVIRONMENT: staging
    LOG_LEVEL: INFO
    REDIS_HOST: staging-redis-host
    DB_HOST: staging-db-host
    
  Production:
    ENVIRONMENT: production
    LOG_LEVEL: WARN
    REDIS_HOST: prod-redis-host
    DB_HOST: prod-db-host
    
Secret References:
  - GEMINI_API_KEY: projects/PROJECT_ID/secrets/gemini-api-key/versions/latest
  - IMAGEN_API_KEY: projects/PROJECT_ID/secrets/imagen-api-key/versions/latest
  - DB_PASSWORD: projects/PROJECT_ID/secrets/database-password/versions/latest
```

---


---

## æ”¹è¨‚å±¥æ­´

| ç‰ˆæ•° | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | æ‹…å½“è€… |
|------|------|----------|--------|
| 1.0 | 2025-01-20 | åˆç‰ˆä½œæˆï¼ˆè»½é‡ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—æ§‹æˆï¼‰ | Claude Code |

---

## ã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™çŠ¶æ³

### æ•´å‚™å®Œäº†çŠ¶æ³ï¼ˆ2025-08-24 æ›´æ–°ï¼‰

| ã‚µãƒ¼ãƒ“ã‚¹ | è©³ç´° | æ•´å‚™çŠ¶æ³ | æœˆé¡ã‚³ã‚¹ãƒˆï¼ˆç›®å®‰ï¼‰ |
|----------|------|----------|-------------------|
| **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°** |  |  |  |
| VPC Network | manga-service-vpc (10.0.0.0/16) | âœ… å®Œäº† | $0ï¼ˆç„¡æ–™æ ï¼‰ |
| ã‚µãƒ–ãƒãƒƒãƒˆ | ãƒ‘ãƒ–ãƒªãƒƒã‚¯: 10.0.1.0/24<br>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ: 10.0.2.0/24 | âœ… å®Œäº† | $0ï¼ˆç„¡æ–™æ ï¼‰ |
| ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ« | å†…éƒ¨é€šä¿¡ã€HTTPSã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ | âœ… å®Œäº† | $0ï¼ˆç„¡æ–™æ ï¼‰ |
| VPC Peering | Service Networkingç”¨ | âœ… å®Œäº† | $0ï¼ˆç„¡æ–™æ ï¼‰ |
| Direct VPC Egress | Cloud Run â†’ VPCæ¥ç¶š | âœ… è¨­è¨ˆå¤‰æ›´æ¸ˆã¿ | $0ï¼ˆç„¡æ–™ï¼‰ |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** |  |  |  |
| Cloud SQL | PostgreSQL 15, db-f1-micro | ğŸ”„ ä½œæˆä¸­ | $25-30/æœˆ |
| Memory Store Redis | 1GB, Basic tier | âœ… å®Œäº†<br>IP: 10.85.114.155 | $40-50/æœˆ |
| **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸** |  |  |  |
| Input Data Bucket | 90æ—¥è‡ªå‹•å‰Šé™¤ | âœ… å®Œäº† | $2-5/æœˆ |
| Output Images Bucket | CDNå¯¾å¿œã€CORSæœ‰åŠ¹ | âœ… å®Œäº† | $5-15/æœˆ |
| Final Products Bucket | ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«è¨­å®š | âœ… å®Œäº† | $3-10/æœˆ |
| Temp Data Bucket | 7æ—¥è‡ªå‹•å‰Šé™¤ | âœ… å®Œäº† | $1-3/æœˆ |
| **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°** |  |  |  |
| ~~Pub/Sub Topics~~ | ~~phase-completed, generation-requests~~ | âŒ å‰Šé™¤æ¸ˆã¿ | ~~$1-5/æœˆ~~ |
| ~~Pub/Sub Subscriptions~~ | ~~phase-completed-sub~~ | âŒ å‰Šé™¤æ¸ˆã¿ | ~~$0ï¼ˆå«ã¾ã‚Œã‚‹ï¼‰~~ |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** |  |  |  |
| Service Accounts | Main, Devç”¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ | âœ… å®Œäº† | $0ï¼ˆç„¡æ–™ï¼‰ |
| IAM Policies | æœ€å°æ¨©é™è¨­å®š | âœ… å®Œäº† | $0ï¼ˆç„¡æ–™ï¼‰ |
| Service Networking | Private Google Access | âœ… å®Œäº† | $0ï¼ˆç„¡æ–™ï¼‰ |
| **API** |  |  |  |
| AI Platform API | Vertex AIãƒ»Gemini Proãƒ»Imagençµ±åˆ | âœ… æœ‰åŠ¹åŒ–æ¸ˆã¿ | ä½¿ç”¨é‡èª²é‡‘ |
| Cloud Run API | ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œ | âœ… æœ‰åŠ¹åŒ–æ¸ˆã¿ | ä½¿ç”¨é‡èª²é‡‘ |
| ãã®ä»–å¿…è¦API | 12å€‹ã™ã¹ã¦æœ‰åŠ¹åŒ– | âœ… å®Œäº† | $0ï¼ˆç„¡æ–™ï¼‰ |

### æ®‹ä½œæ¥­ãƒ»èª²é¡Œ

| é …ç›® | å„ªå…ˆåº¦ | è©³ç´° | å¯¾å¿œäºˆå®š |
|------|--------|------|---------|
| Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤ | ä¸­ | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é…ç½® | é–‹ç™ºå®Œäº†å¾Œ |
| ç›£è¦–ãƒ»ãƒ­ã‚°è¨­å®š | ä½ | ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³é‹ç”¨æ™‚ | é‹ç”¨é–‹å§‹å‰ |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚° | ä½ | Direct VPC Egressæœ€é©åŒ– | è² è·ãƒ†ã‚¹ãƒˆå¾Œ |

### âœ… **è§£æ±ºæ¸ˆã¿èª²é¡Œ**
- ~~VPC Connectorå‰Šé™¤~~ â†’ **å®Œäº†ï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰**
- ~~Cloud SQLå®Œäº†å¾…ã¡~~ â†’ **å®Œäº†ï¼ˆDBãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆæ¸ˆã¿ï¼‰**
- ~~Vertex AI APIæ¨©é™~~ â†’ **å®Œäº†ï¼ˆAI Platform APIçµŒç”±ã§åˆ©ç”¨å¯èƒ½ï¼‰**

### ç¾åœ¨ã®ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Šï¼ˆDirect VPC Egressæ¡ç”¨å¾Œï¼‰
- **åŸºç›¤ã‚³ã‚¹ãƒˆ**: $76-128/æœˆï¼ˆå®Ÿè£…æ¸ˆã¿ã€VPC Connectorå‰Šé™¤ã§$20-30å‰Šæ¸›ï¼‰
- **APIä½¿ç”¨æ–™**: åˆ©ç”¨é‡ã«å¿œã˜ã¦å¤‰å‹•
- **ç·åˆè¨ˆ**: $80-170/æœˆï¼ˆåˆæœŸæ®µéšã€æœˆé¡$20-30ã®å‰Šæ¸›åŠ¹æœï¼‰

## 7. é–‹ç™ºç’°å¢ƒè¨­è¨ˆ

### 7.1 é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

#### å¿…è¦ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
| è¦ç´  | è¦ä»¶ | ç”¨é€” |
|------|------|------|
| Python | 3.11+ | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™º |
| Docker | Docker & Docker Compose | ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ãƒ•ãƒ© |
| PostgreSQL | 15+ | é–‹ç™ºç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ |
| Redis | 7+ | é–‹ç™ºç”¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| Node.js | 18+ | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™º |
| Google Cloud SDK | æœ€æ–°ç‰ˆ | ã‚¯ãƒ©ã‚¦ãƒ‰é€£æºãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ |

#### å¿…è¦ãªGoogle Cloud APIs
```
- Vertex AI API
- Cloud Storage API
- Secret Manager API
- Cloud SQL API
- Cloud Run API
```

### 7.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºç’°å¢ƒ

#### é–‹ç™ºç’°å¢ƒåˆæœŸåŒ–
```bash
# 1. ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/your-repo/manga-generation-service.git
cd manga-generation-service

# 2. Pythonä»®æƒ³ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
cd backend
python3 -m venv venv
source venv/bin/activate  # Mac/Linux
# or venv\Scripts\activate  # Windows

# 3. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install --upgrade pip
pip install -r requirements.txt
```

#### é–‹ç™ºç”¨ç’°å¢ƒå¤‰æ•°è¨­å®š
```env
# Database
DATABASE_URL=postgresql+asyncpg://manga_user:manga_pass@localhost:5432/manga_db

# Redis
REDIS_URL=redis://localhost:6379/0

# Security
SECRET_KEY=your-secret-key-here-minimum-32-chars
JWT_ALGORITHM=HS256

# Google Cloud (é–‹ç™ºæ™‚ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
GOOGLE_CLOUD_PROJECT=your-project-id
GOOGLE_APPLICATION_CREDENTIALS=/path/to/credentials.json
VERTEXAI_LOCATION=asia-northeast1

# AI Models
GEMINI_MODEL=gemini-1.5-pro
IMAGEN_MODEL=imagen-4

# CORS (é–‹ç™ºæ™‚)
CORS_ORIGINS=http://localhost:3000,http://localhost:8000

# Debug
DEBUG=true
ENV=development
```

#### Docker Composeé–‹ç™ºã‚¤ãƒ³ãƒ•ãƒ©
```yaml
# docker-compose.yml (é–‹ç™ºç”¨)
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: manga_db
      POSTGRES_USER: manga_user
      POSTGRES_PASSWORD: manga_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### 7.3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºç’°å¢ƒ

#### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
```bash
cd frontend
npm install

# ç’°å¢ƒå¤‰æ•°è¨­å®š
cp .env.example .env.local

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev
# http://localhost:3000 ã§ç¢ºèª
```

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒå¤‰æ•°
```env
NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
NEXT_PUBLIC_WS_URL=ws://localhost:8000/ws
```

### 7.4 çµ±åˆé–‹ç™ºç’°å¢ƒ

#### å…¨ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```bash
#!/bin/bash
# scripts/setup.sh

echo "ğŸš€ AI Manga Generation Service - Development Setup"

# Docker ã‚¤ãƒ³ãƒ•ãƒ©èµ·å‹•
echo "ğŸ“¦ Starting infrastructure services..."
docker-compose up -d

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
echo "ğŸ—ƒï¸ Running database migrations..."
cd backend
alembic upgrade head

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•
echo "âš™ï¸ Starting backend service..."
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 &

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰èµ·å‹•
echo "ğŸ¨ Starting frontend service..."
cd ../frontend
npm run dev &

echo "âœ… Development environment ready!"
echo "ğŸ“– API Documentation: http://localhost:8000/docs"
echo "ğŸŒ Frontend: http://localhost:3000"
```

### 7.5 é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

#### 1. ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ–ãƒ©ãƒ³ãƒä½œæˆ
```bash
git checkout -b feature/your-feature-name
```

#### 2. é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«
| ã‚¹ãƒ†ãƒƒãƒ— | ã‚³ãƒãƒ³ãƒ‰ | è©³ç´° |
|----------|----------|------|
| ã‚³ãƒ¼ãƒ‰å¤‰æ›´ | `vim app/...` | Phase Agentã€APIã€ã‚µãƒ¼ãƒ“ã‚¹å¤‰æ›´ |
| ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ | `pytest tests/ -v` | Unitãƒ»Integration ãƒ†ã‚¹ãƒˆ |
| ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ | `black app/ tests/` | ã‚³ãƒ¼ãƒ‰æ•´å½¢ |
| ãƒªãƒ³ãƒˆ | `flake8 app/ tests/` | ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ |
| ã‚³ãƒŸãƒƒãƒˆ | `git commit -m "feat: ..."` | å¤‰æ›´ç¢ºå®š |

#### 3. å“è³ªä¿è¨¼
```bash
# Coverage report
pytest --cov=app --cov-report=html

# å‹ãƒã‚§ãƒƒã‚¯
mypy app/

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
bandit -r app/
```

### 7.6 ç›£è¦–ãƒ»ãƒ‡ãƒãƒƒã‚°

#### ãƒ­ãƒ¼ã‚«ãƒ«ç›£è¦–
```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°
tail -f logs/app.log

# Docker ã‚µãƒ¼ãƒ“ã‚¹ç¢ºèª
docker-compose ps
docker-compose logs -f

# WebSocketæ¥ç¶šãƒ†ã‚¹ãƒˆ
wscat -c ws://localhost:8000/ws/session/test-session-id
```

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
```bash
# API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š
curl -w "@curl-format.txt" -s -o /dev/null http://localhost:8000/api/v1/manga/generate

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–
python -m memory_profiler app/main.py
```

### 7.7 ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### å…±é€šã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºç­–
| ã‚¨ãƒ©ãƒ¼ | åŸå›  | è§£æ±ºç­– |
|--------|------|--------|
| `pydantic-settings not found` | ä¾å­˜é–¢ä¿‚ä¸è¶³ | `pip install pydantic-settings` |
| `psycopg2 compilation error` | PostgreSQLé–‹ç™ºãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸è¶³ | `brew install postgresql` (Mac) |
| `Redis connection refused` | Redisã‚µãƒ¼ãƒ“ã‚¹æœªèµ·å‹• | `docker-compose restart redis` |
| `Permission denied` | Dockeræ¨©é™ä¸è¶³ | `sudo usermod -aG docker $USER` |

#### ãƒ‡ãƒãƒƒã‚°ã‚³ãƒãƒ³ãƒ‰
```bash
# DBæ¥ç¶šãƒ†ã‚¹ãƒˆ
psql postgresql://manga_user:manga_pass@localhost:5432/manga_db

# Redisæ¥ç¶šãƒ†ã‚¹ãƒˆ
redis-cli ping

# ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ç¢ºèª
docker-compose ps
docker-compose logs <service-name>

# å…¨å‰Šé™¤ãƒ»å†æ§‹ç¯‰
docker-compose down -v
docker-compose up -d --build
```

### 7.8 ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³é€£æº

#### Google Cloudæ¥ç¶šè¨­å®š
```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
gcloud config set project YOUR_PROJECT_ID

# èªè¨¼è¨­å®š
gcloud auth application-default login

# å¿…è¦ãªAPIã‚’æœ‰åŠ¹åŒ–
./scripts/gcloud-setup.sh
```

#### Cloud Runãƒ†ã‚¹ãƒˆç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
```bash
# Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
docker build -t gcr.io/YOUR_PROJECT_ID/manga-service .

# ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥
docker push gcr.io/YOUR_PROJECT_ID/manga-service

# ãƒ†ã‚¹ãƒˆç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
gcloud run deploy manga-service-dev \
  --image gcr.io/YOUR_PROJECT_ID/manga-service \
  --platform managed \
  --region asia-northeast1 \
  --allow-unauthenticated
```

### 7.9 é–‹ç™ºç’°å¢ƒãƒªã‚½ãƒ¼ã‚¹

#### å¿…è¦ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- API Documentation: http://localhost:8000/docs
- Backend Implementation Guide: `docs/Backend_Implementation_Guide.md`
- System Architecture: `docs/04.ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸.md`
- AI Implementation: `docs/08.AIè¨­è¨ˆæ›¸.md`

#### ã‚µãƒãƒ¼ãƒˆä½“åˆ¶
1. `docs/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç¢ºèª
2. GitHub Issues ã§ã®æ—¢çŸ¥å•é¡Œæ¤œç´¢
3. æ–°è¦Issueä½œæˆãƒ»æŠ€è¡“æ”¯æ´ä¾é ¼

---

**æ–‡æ›¸æ‰¿èª**
- ã‚¤ãƒ³ãƒ•ãƒ©ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ: [ç½²å] æ—¥ä»˜: [æ—¥ä»˜]
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢: [ç½²å] æ—¥ä»˜: [æ—¥ä»˜]
- SREã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢: [ç½²å] æ—¥ä»˜: [æ—¥ä»˜]