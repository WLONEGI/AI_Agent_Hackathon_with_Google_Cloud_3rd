# AI漫画生成サービス インフラ設計書

**文書管理情報**
- 文書ID: INF-DOC-001
- 作成日: 2025-01-20
- 版数: 2.0
- 承認者: 根岸祐樹
- 関連文書: SYS-DOC-001（システム設計書）、REQ-DOC-001（要件定義書）
- 更新履歴:
  - v1.0: 基本インフラ設計完成
  - v2.0: 開発環境設計統合 (Development_Setup_Guide.md統合)

## 目次

- [1. インフラ概要](#1-インフラ概要)
  - [1.1 設計方針](#11-設計方針)
  - [1.2 アーキテクチャ概要](#12-アーキテクチャ概要)
- [2. ネットワーク設計](#2-ネットワーク設計)
  - [2.1 VPC構成](#21-vpc構成)
  - [2.2 サブネット設計](#22-サブネット設計)
  - [2.3 ファイアウォール設定](#23-ファイアウォール設定)
- [3. コンピューティング設計](#3-コンピューティング設計)
  - [3.1 Cloud Run構成](#31-cloud-run構成)
  - [3.2 オートスケーリング設計](#32-オートスケーリング設計)
  - [3.3 サービスアカウント設計](#33-サービスアカウント設計)
- [4. データストレージ設計](#4-データストレージ設計)
  - [4.1 Cloud SQL設計](#41-cloud-sql設計)
  - [4.2 Redis単一インスタンス設計](#42-redis単一インスタンス設計)
  - [4.3 Cloud Storage設計](#43-cloud-storage設計)
- [5. セキュリティ設計](#5-セキュリティ設計)
  - [5.1 IAM設計](#51-iam設計)
  - [5.2 Secret Manager](#52-secret-manager)
  - [5.3 ネットワークセキュリティ](#53-ネットワークセキュリティ)
- [6. CI/CD設計](#6-cicd設計)
  - [6.1 Cloud Build設定](#61-cloud-build設定)
  - [6.2 デプロイメント戦略](#62-デプロイメント戦略)
  - [6.3 環境管理](#63-環境管理)
- [7. 開発環境設計](#7-開発環境設計)
  - [7.1 開発環境セットアップ](#71-開発環境セットアップ)
  - [7.2 バックエンド開発環境](#72-バックエンド開発環境)
  - [7.3 フロントエンド開発環境](#73-フロントエンド開発環境)
  - [7.4 統合開発環境](#74-統合開発環境)
  - [7.5 開発ワークフロー](#75-開発ワークフロー)
  - [7.6 監視・デバッグ](#76-監視デバッグ)
  - [7.7 トラブルシューティング](#77-トラブルシューティング)
  - [7.8 プロダクション連携](#78-プロダクション連携)
  - [7.9 開発環境リソース](#79-開発環境リソース)

---

## 1. インフラ概要

### 1.1 設計方針

| 方針 | 内容 | 理由 |
|------|------|------|
| スタートアップ最適化 | 軽量構成でスタート、段階的拡張 | 初期コスト抑制、迅速なMVP展開 |
| Google Cloud ネイティブ | GCP標準サービス活用 | 運用負荷削減、統合管理 |
| シンプルネットワーク | 単一VPC、必要最小限の分離 | 複雑性排除、トラブルシューティング簡素化 |
| フルマネージド優先 | Cloud SQL、Memory Store活用 | 運用工数削減、自動化推進 |

### 1.2 アーキテクチャ概要

```mermaid
graph TB
    subgraph "Internet"
        U[Users]
    end
    
    subgraph "Google Cloud Platform"
        subgraph "Load Balancer"
            LB[Cloud Load Balancer]
            CDN[Cloud CDN]
        end
        
        subgraph "VPC: manga-service-vpc (10.0.0.0/16)"
            subgraph "Public Subnet (10.0.1.0/24)"
                CR[Cloud Run Services]
            end
            
            subgraph "Private Subnet (10.0.2.0/24)"
                DB[Cloud SQL PostgreSQL]
                RD[Memory Store Redis]
            end
        end
        
        subgraph "Storage"
            CS[Cloud Storage]
        end
        
        subgraph "External APIs"
            GM[Gemini Pro]
            IM[Imagen 4]
        end
        
        subgraph "Monitoring"
            MON[Cloud Monitoring]
            LOG[Cloud Logging]
        end
    end
    
    U --> LB
    LB --> CDN
    CDN --> CR
    CR --> DB
    CR --> RD
    CR --> CS
    CR --> GM
    CR --> IM
    CR --> MON
    CR --> LOG
```

---

## 2. ネットワーク設計

### 2.1 VPC構成

#### 基本設定
```yaml
VPC Configuration:
  Name: manga-service-vpc
  Region: asia-northeast1 (Tokyo)
  IP Range: 10.0.0.0/16
  Route Mode: Regional
  DNS Policy: Default
```

#### Terraform設定例
```hcl
resource "google_compute_network" "manga_vpc" {
  name                    = "manga-service-vpc"
  auto_create_subnetworks = false
  mtu                     = 1460
}

resource "google_compute_router" "manga_router" {
  name    = "manga-router"
  region  = var.region
  network = google_compute_network.manga_vpc.id
}

resource "google_compute_router_nat" "manga_nat" {
  name                               = "manga-nat"
  router                             = google_compute_router.manga_router.name
  region                             = var.region
  nat_ip_allocate_option             = "AUTO_ONLY"
  source_subnetwork_ip_ranges_to_nat = "ALL_SUBNETWORKS_ALL_IP_RANGES"
}
```

### 2.2 サブネット設計

#### サブネット構成
| サブネット名 | CIDR | 用途 | アクセス |
|-------------|------|------|---------|
| manga-public | 10.0.1.0/24 | Cloud Run Connector | Public |
| manga-private | 10.0.2.0/24 | Cloud SQL, Redis | Private |
| manga-management | 10.0.3.0/24 | 管理・監視 | Private |

#### Terraform設定
```hcl
# パブリックサブネット（Cloud Run用）
resource "google_compute_subnetwork" "manga_public" {
  name          = "manga-public"
  ip_cidr_range = "10.0.1.0/24"
  region        = var.region
  network       = google_compute_network.manga_vpc.id
}

# プライベートサブネット（データベース用）
resource "google_compute_subnetwork" "manga_private" {
  name          = "manga-private"
  ip_cidr_range = "10.0.2.0/24"
  region        = var.region
  network       = google_compute_network.manga_vpc.id
  
  private_ip_google_access = true
  
  secondary_ip_range {
    range_name    = "manga-pods"
    ip_cidr_range = "10.1.0.0/16"
  }
}
```

### 2.3 ファイアウォール設定

#### セキュリティルール
```hcl
# HTTPS流入許可
resource "google_compute_firewall" "allow_https" {
  name    = "manga-allow-https"
  network = google_compute_network.manga_vpc.name

  allow {
    protocol = "tcp"
    ports    = ["443"]
  }

  source_ranges = ["0.0.0.0/0"]
  target_tags   = ["https-server"]
}

# VPC内部通信許可
resource "google_compute_firewall" "allow_internal" {
  name    = "manga-allow-internal"
  network = google_compute_network.manga_vpc.name

  allow {
    protocol = "tcp"
    ports    = ["0-65535"]
  }

  allow {
    protocol = "udp"
    ports    = ["0-65535"]
  }

  source_ranges = ["10.0.0.0/16"]
}

# Health Check許可
resource "google_compute_firewall" "allow_health_check" {
  name    = "manga-allow-health-check"
  network = google_compute_network.manga_vpc.name

  allow {
    protocol = "tcp"
    ports    = ["8080"]
  }

  source_ranges = ["130.211.0.0/22", "35.191.0.0/16"]
  target_tags   = ["cloud-run-service"]
}
```

### 2.4 Direct VPC Egress設定

#### Cloud Run VPC接続
```yaml
# Direct VPC Egress使用（VPC Connector不要・コスト$0）
Network Configuration:
  Connection Type: Direct VPC Egress
  VPC Network: manga-service-vpc
  Subnet: manga-private (10.0.2.0/24)
  Benefits:
    - VPC Connector不要（月額$20-40削減）
    - 高パフォーマンス（直接VPC接続）
    - シンプルな設定
```

#### Terraform設定例
```hcl
# Direct VPC Egress用ルーティング設定
resource "google_compute_route" "manga_private_route" {
  name             = "manga-private-route"
  dest_range       = "0.0.0.0/0"
  network          = google_compute_network.manga_vpc.name
  next_hop_gateway = "default-internet-gateway"
  priority         = 1000
  
  # プライベートサブネットからの外向き通信用
  tags = ["cloud-run-egress"]
}

# Cloud Run用IAM権限
resource "google_project_iam_member" "run_network_admin" {
  project = var.project_id
  role    = "roles/run.networkAdmin"
  member  = "serviceAccount:${google_service_account.manga_service.email}"
}
```

---

## 3. コンピューティング設計

### 3.1 Cloud Run構成

#### 軽量化構成設定（Direct VPC Egress使用）
```yaml
# Phase 1-7 共通設定（新フロー版 + Direct VPC Egress）
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: phase-service-template
  annotations:
    run.googleapis.com/ingress: internal-and-cloud-load-balancing
spec:
  template:
    metadata:
      annotations:
        run.googleapis.com/cpu: "1"
        run.googleapis.com/memory: "2Gi"
        run.googleapis.com/execution-environment: gen2
        # Direct VPC Egress使用（VPC Connector不要）
        run.googleapis.com/network-interfaces: '[{"network":"manga-service-vpc","subnetwork":"manga-private"}]'
        run.googleapis.com/cloudsql-instances: manga-db-instance
    spec:
      containerConcurrency: 50  # 軽量化のため削減
      timeoutSeconds: 300       # 5分タイムアウト
      serviceAccountName: manga-service-account
      containers:
      - image: gcr.io/PROJECT_ID/phase-service:latest
        ports:
        - containerPort: 8080
        resources:
          limits:
            cpu: "1"
            memory: "2Gi"
        env:
        - name: REDIS_HOST
          value: "10.0.2.10"
        - name: DB_HOST
          value: "10.0.2.5"
```

#### サービス別カスタマイズ
```yaml
# Phase 5(シーン画像生成)のみリソース増強
Phase5_Overrides:
  cpu: "2"           # Imagen併用のため2倍
  memory: "4Gi"      # メモリも2倍
  timeout: 60        # 40秒+バッファ
  concurrency: 5     # 並列処理数制限

# Phase 2(キャラビジュアル生成)の設定
Phase2_Overrides:
  cpu: "1.5"         # 簡易画像生成用
  memory: "3Gi"      # メモリ少し増強
  timeout: 20        # 12秒+バッファ
```

### 3.2 オートスケーリング設計

#### スケーリング設定
| 項目 | 設定値 | 説明 |
|------|--------|------|
| 最小インスタンス | 1 | コールドスタート対策 |
| 最大インスタンス | 50 | ピーク時対応 |
| CPU閾値 | 80% | スケールアウトトリガー |
| メモリ閾値 | 70% | スケールアウトトリガー |
| スケールダウン遅延 | 300秒 | 頻繁なスケーリング防止 |

```yaml
Scaling Configuration:
  Min Instances: 1     # コールドスタート対策
  Max Instances: 50    # 統合サービスのため上限引き上げ
  Target CPU: 80%      # 効率的なリソース利用
  Target Memory: 70%   # メモリ効率重視
  Scale Down Delay: 300s  # 5分間のクールダウン
```

### 3.3 サービスアカウント設計

#### IAM ロール設計
```yaml
Service Accounts:
  manga-service-account:
    roles:
      - roles/cloudsql.client
      - roles/redis.editor
      - roles/storage.objectAdmin
      - roles/logging.logWriter
      - roles/monitoring.metricWriter
      - roles/secretmanager.secretAccessor

  manga-cicd-account:
    roles:
      - roles/run.developer
      - roles/storage.admin
      - roles/cloudbuild.builds.editor
      - roles/iam.serviceAccountUser
```

---

## 4. データストレージ設計

### 4.1 Cloud SQL設計

#### インスタンス設定（軽量スタートアップ版）
```yaml
Cloud SQL Configuration:
  Instance ID: manga-db-instance
  Database Version: PostgreSQL 15
  Region: asia-northeast1
  Zone: asia-northeast1-a
  
  Machine Type: db-standard-1  # スタートアップ向け軽量版
  CPU: 1 vCPU
  Memory: 3.75 GB
  Storage: 100 GB SSD (Auto-increase enabled)
  
  Network:
    Private IP: 10.0.2.5
    Authorized Networks: VPC manga-service-vpc
    SSL: Required
  
  Backup:
    Automated Backup: Enabled
    Backup Window: 03:00-04:00 JST
    Point-in-time Recovery: 7 days
    Retention: 30 days
  
  Maintenance:
    Window: Sunday 04:00-05:00 JST
    Update Strategy: OPPORTUNISTIC
```

#### Terraform設定
```hcl
resource "google_sql_database_instance" "manga_db" {
  name             = "manga-db-instance"
  database_version = "POSTGRES_15"
  region           = var.region

  settings {
    tier = "db-standard-1"  # 軽量版
    
    disk_type    = "PD_SSD"
    disk_size    = 100
    disk_autoresize       = true
    disk_autoresize_limit = 500  # 最大500GB

    backup_configuration {
      enabled                        = true
      start_time                     = "03:00"
      point_in_time_recovery_enabled = true
      backup_retention_settings {
        retained_backups = 30
      }
    }

    ip_configuration {
      ipv4_enabled    = false
      private_network = google_compute_network.manga_vpc.id
      require_ssl     = true
    }

    maintenance_window {
      day  = 7  # Sunday
      hour = 4
    }
  }

  deletion_protection = true
}
```

### 4.2 Redis単一インスタンス設計

#### インスタンス設定
```yaml
Redis Configuration:
  Service: Memory Store for Redis
  Version: Redis 7.0
  Tier: Basic
  Memory: 4GB
  Region: asia-northeast1
  Network: manga-service-vpc
  IP: 10.0.2.10
  
  Estimated Cost: $120/month
  
  Performance:
    - 最大接続数: 65,000
    - スループット: 250,000 ops/sec
    - レイテンシー: <1ms
```

#### Redis接続設定
```python
import redis
import os

class RedisManager:
    def __init__(self):
        self.client = redis.Redis(
            host=os.getenv('REDIS_HOST', '10.0.2.10'),
            port=6379,
            decode_responses=True,
            socket_connect_timeout=5,
            retry_on_timeout=True,
            health_check_interval=30
        )
    
    async def get_connection_pool(self):
        """接続プール設定"""
        return redis.ConnectionPool(
            host=os.getenv('REDIS_HOST', '10.0.2.10'),
            port=6379,
            max_connections=50,
            decode_responses=True
        )

#### プレビューシステムに伴うRedis使用量削減

**変更方針**: プレビューデータのキャッシュをCDN+Cloud Storageに移行
```yaml
Redis Usage Reduction Strategy:
  Before (Redis依存):
    - プレビューデータキャッシュ: ~2GB
    - インタラクティブ状態: ~500MB  
    - バージョン履歴: ~1GB
    Total Redis Usage: ~4GB
    
  After (CDN最適化):
    - プレビューデータ: Cloud Storage + CDN
    - インタラクティブ状態: Cloud Storage + CDN  
    - バージョン履歴: Cloud Storage
    Remaining Redis Usage: ~1GB (セッション管理のみ)
    
  Benefits:
    - Redis費用: $120/月 → $30/月 (75%削減)
    - スケーラビリティ向上
    - レイテンシー改善 (CDN効果)
    - データ永続性向上
```

**Redis新構成**:
```yaml
Redis Optimized Configuration:
  Service: Memory Store for Redis  
  Version: Redis 7.0
  Tier: Basic
  Memory: 1GB (4GBから削減)
  Region: asia-northeast1
  
  New Estimated Cost: $30/month (90$削減)
  
  Primary Usage:
    - WebSocketセッション管理
    - API レート制限カウンタ
    - 一時的な処理状態
    - リアルタイム通知キュー
```

### 4.3 Cloud Storage設計

#### バケット構成（プレビューシステム対応版）
```yaml
Storage Buckets:
  manga-input-data:
    Location: asia-northeast1
    Storage Class: Standard
    Lifecycle:
      - Delete objects older than 90 days
    
  manga-output-images:
    Location: asia-northeast1
    Storage Class: Standard
    Public Access: Enabled (CDN用)
    CORS: Enabled
    
  manga-preview-cache:
    Location: asia-northeast1
    Storage Class: Standard
    Public Access: Enabled (CDN用)
    Purpose: プレビューデータ・インタラクティブコンテンツ
    CDN: Cloud CDN with optimized caching
    Cache Headers:
      - Images: "public, max-age=604800, immutable"
      - Metadata: "public, max-age=1800" 
      - Interactive: "public, max-age=86400"
    CORS: Enabled for interactive content
    Lifecycle:
      - Delete objects older than 30 days
    
  manga-version-snapshots:
    Location: asia-northeast1  
    Storage Class: Standard
    Purpose: プレビューバージョン履歴・比較データ
    Lifecycle:
      - Transition to Nearline after 7 days
      - Delete objects older than 60 days
    
  manga-final-products:
    Location: asia-northeast1
    Storage Class: Standard
    Lifecycle:
      - Transition to Nearline after 30 days
      - Transition to Coldline after 365 days
    
  manga-temp-data:
    Location: asia-northeast1
    Storage Class: Standard
    Lifecycle:
      - Delete objects older than 7 days
```

#### Terraform設定
```hcl
# 入力データ用バケット
resource "google_storage_bucket" "input_data" {
  name     = "${var.project_id}-manga-input-data"
  location = var.region

  lifecycle_rule {
    condition {
      age = 90
    }
    action {
      type = "Delete"
    }
  }

  versioning {
    enabled = true
  }

  encryption {
    default_kms_key_name = google_kms_crypto_key.storage_key.id
  }
}

# 出力画像用バケット（CDN対応）
resource "google_storage_bucket" "output_images" {
  name     = "${var.project_id}-manga-output-images"
  location = var.region

  cors {
    origin          = ["https://*.manga-service.com"]
    method          = ["GET", "HEAD"]
    response_header = ["*"]
    max_age_seconds = 3600
  }

  uniform_bucket_level_access = true
}

# プレビューキャッシュ用バケット（CDN最適化）
resource "google_storage_bucket" "preview_cache" {
  name     = "${var.project_id}-manga-preview-cache"
  location = var.region

  cors {
    origin          = ["https://*.manga-service.com", "https://localhost:*"]
    method          = ["GET", "HEAD", "PUT", "POST"]
    response_header = ["*"]
    max_age_seconds = 3600
  }

  lifecycle_rule {
    condition {
      age = 30
    }
    action {
      type = "Delete"
    }
  }

  uniform_bucket_level_access = true
}

# バージョンスナップショット用バケット  
resource "google_storage_bucket" "version_snapshots" {
  name     = "${var.project_id}-manga-version-snapshots"
  location = var.region

  lifecycle_rule {
    condition {
      age = 7
    }
    action {
      type = "SetStorageClass"
      storage_class = "NEARLINE"
    }
  }

  lifecycle_rule {
    condition {
      age = 60  
    }
    action {
      type = "Delete"
    }
  }

  versioning {
    enabled = true
  }
}

# 一時データ用バケット
resource "google_storage_bucket" "temp_data" {
  name     = "${var.project_id}-manga-temp-data"
  location = var.region

  lifecycle_rule {
    condition {
      age = 7
    }
    action {
      type = "Delete"
    }
  }
}
```

---

## 5. セキュリティ設計

### 5.1 IAM設計

#### 最小権限の原則
```yaml
Service Account Roles:

  manga-cicd-sa:
    - roles/run.developer
    - roles/cloudbuild.builds.editor
    - roles/storage.admin
    - roles/iam.serviceAccountUser
```

### 5.2 Secret Manager

#### シークレット管理
```yaml
Secrets Configuration:
  manga-secret-key:
    Description: "Application JWT Secret Key"
    Replication: automatic
    Access: manga-service-account
    Status: ✅ Implemented
    Usage: Cloud Run environment variable
    
  manga-database-url:
    Description: "PostgreSQL Connection URL"
    Replication: automatic  
    Access: manga-service-account
    Status: ✅ Implemented
    Usage: Cloud Run environment variable
    
  gemini-api-key:
    Description: "Google Gemini Pro API Key"
    Replication: automatic
    Access: manga-service-account
    Status: ⏳ Planned
    
  imagen-api-key:
    Description: "Google Imagen 4 API Key"
    Replication: automatic
    Access: manga-service-account
    Status: ⏳ Planned
    
  firebase-credentials:
    Description: "Firebase Service Account Credentials"
    Replication: automatic
    Access: manga-service-account
    Status: ⏳ Planned
```

#### Terraform設定
```hcl
resource "google_secret_manager_secret" "gemini_api_key" {
  secret_id = "gemini-api-key"

  replication {
    automatic = true
  }
}

resource "google_secret_manager_secret_iam_binding" "gemini_access" {
  project   = var.project_id
  secret_id = google_secret_manager_secret.gemini_api_key.secret_id
  role      = "roles/secretmanager.secretAccessor"

  members = [
    "serviceAccount:${google_service_account.manga_service.email}",
  ]
}
```

### 5.3 HITL (Human-in-the-Loop) インフラ設計

#### WebSocket Infrastructure
```yaml
Cloud Run WebSocket Configuration:
  WebSocket Support: Enabled
  Connection Timeout: 30 minutes
  Max Concurrent Connections: 1000
  
  Environment Variables:
    WEBSOCKET_ENABLED: "true"
    HITL_TIMEOUT_SECONDS: "30"
    MAX_FEEDBACK_WAIT_TIME: "1800"  # 30 minutes
    
  Health Check:
    Path: /ws/health
    Interval: 30s
    Timeout: 5s
```

#### Session Management Infrastructure
```yaml
Redis Session Configuration:
  Purpose: HITL session storage
  TTL: 3600 seconds (1 hour)
  Memory Allocation: 2GB
  
  Session Data Structure:
    session:{request_id}:
      - user_id: string
      - current_phase: integer
      - feedback_timeout: timestamp
      - session_start: timestamp
      - phase_results: json
      
  Pub/Sub Channels:
    hitl_feedback:{request_id}: Real-time feedback
    phase_progress:{request_id}: Phase completion updates
    session_timeout:{request_id}: Timeout notifications
```

#### Feedback Queue Management
```yaml
Cloud Pub/Sub Configuration:
  Topics:
    - hitl-feedback-topic
    - phase-completion-topic  
    - session-management-topic
    
  Subscriptions:
    - hitl-feedback-processor
    - phase-transition-handler
    - session-cleanup-service
    
  Dead Letter Queue:
    Max Delivery Attempts: 5
    Dead Letter Topic: hitl-feedback-dlq
    Retention Period: 7 days
```

#### HITL Monitoring Infrastructure
```yaml
Cloud Monitoring Metrics:
  Custom Metrics:
    - hitl/session_duration
    - hitl/feedback_timeout_rate
    - hitl/user_engagement_score
    - hitl/phase_completion_time
    - hitl/retry_rate_per_phase
    
  Alerting Policies:
    High Timeout Rate:
      Condition: hitl/feedback_timeout_rate > 0.3
      Notification: Email + Slack
      
    Session Duration Alert:
      Condition: hitl/session_duration > 30 minutes
      Action: Auto-cleanup trigger
      
  Dashboards:
    - HITL Performance Overview
    - User Engagement Analytics  
    - Phase-wise Quality Metrics
```

#### Chat Infrastructure
```yaml
Chat Service Configuration:
  Service: Cloud Run (chat-service)
  Instances: 
    Min: 2
    Max: 100
  CPU: 2
  Memory: 4Gi
  
  WebSocket Settings:
    Max Message Size: 10KB
    Ping Interval: 30s
    Pong Timeout: 10s
    Compression: Enabled
    
  Chat Database (Firestore):
    Collections:
      chat_sessions:
        - session_id: string
        - request_id: string
        - user_id: string
        - created_at: timestamp
        - last_activity: timestamp
        
      chat_messages:
        - message_id: string
        - session_id: string
        - phase: integer
        - content: string
        - message_type: enum(text|quick_action|system)
        - created_at: timestamp
        - processed: boolean
        
      chat_intents:
        - intent_id: string
        - message_id: string
        - parsed_intent: json
        - confidence_score: float
        - applied: boolean
```

#### Chat Message Processing Pipeline
```yaml
Message Processing Infrastructure:
  Gemini Pro Integration:
    Model: gemini-pro
    Purpose: Natural language understanding
    Rate Limit: 60 requests/minute
    
    Processing Flow:
      1. Message received via WebSocket
      2. Store in Firestore
      3. Send to Gemini Pro for intent parsing
      4. Store parsed intent
      5. Apply feedback to phase data
      6. Send confirmation via WebSocket
      
  Redis Cache for Chat:
    Purpose: Real-time message caching
    Structure:
      chat:{session_id}:messages: List of recent messages
      chat:{session_id}:typing: Typing indicators
      chat:{session_id}:online: Online status
    TTL: 1 hour after last activity
    
  Cloud Functions for Chat:
    process-chat-message:
      Trigger: Firestore onCreate (chat_messages)
      Runtime: Python 3.11
      Memory: 512MB
      Timeout: 60s
      
    cleanup-chat-sessions:
      Trigger: Cloud Scheduler (every hour)
      Purpose: Clean inactive sessions
      
    aggregate-chat-analytics:
      Trigger: Cloud Scheduler (daily)
      Purpose: Analyze chat patterns
```

#### Real-time Notification Infrastructure
```yaml
Notification System:
  Cloud Tasks for Async Processing:
    Queues:
      - chat-notification-queue
      - feedback-processing-queue
      - preview-generation-queue
      
    Configuration:
      Max Concurrent Dispatches: 100
      Max Retry Attempts: 3
      Rate Limits: 500/s
      
  Firebase Cloud Messaging (Optional):
    Purpose: Mobile/Web push notifications
    Topics:
      - phase_complete
      - feedback_timeout_warning
      - generation_complete
```

#### Quality Gate Infrastructure  
```yaml
BigQuery Analytics:
  Dataset: manga_quality_analytics
  Tables:
    - phase_quality_scores
    - user_feedback_analysis
    - retry_patterns
    - quality_trends
    - chat_interaction_metrics
    
  Scheduled Queries:
    - Daily quality reports
    - Weekly trend analysis
    - Chat engagement metrics
    - Monthly performance review
    
  Data Export:
    Format: JSON
    Schedule: Real-time streaming
    Destination: Cloud Storage bucket
```

### 5.4 ネットワークセキュリティ

#### VPCセキュリティ
```yaml
Security Configuration:
  Private Google Access: Enabled
  Private Service Connect: Enabled for Google APIs
  
  Firewall Priority:
    1. Deny All (Priority: 65534)
    2. Allow HTTPS (Priority: 1000)
    3. Allow Internal VPC (Priority: 1001)
    4. Allow Health Check (Priority: 1002)
  
  DDoS Protection: 
    Cloud Armor: Basic (free tier)
    Rate Limiting: 1000 req/min per IP
```

---


---

## 6. CI/CD設計

### 6.1 Cloud Build設定

#### ビルドパイプライン
```yaml
# cloudbuild.yaml
steps:
  # テスト実行
  - name: 'python:3.11'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        pip install -r requirements.txt
        pytest tests/ --cov=./ --cov-report=xml
    
  # セキュリティスキャン
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud components install local-extract
        gcloud beta code security-analysis scan ./
    
  # Dockerイメージビルド（統合サービス）
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/manga-generation:${SHORT_SHA}'
      - '-t'
      - 'gcr.io/$PROJECT_ID/manga-generation:latest'
      - '.'
    
  # イメージプッシュ
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/manga-generation:${SHORT_SHA}'
    
  # Cloud Runデプロイ
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud run deploy manga-generation-service \
          --image gcr.io/$PROJECT_ID/manga-generation:${SHORT_SHA} \
          --region asia-northeast1 \
          --platform managed \
          --cpu 8 \
          --memory 32Gi \
          --timeout 600 \
          --min-instances 1 \
          --max-instances 50 \
          --no-allow-unauthenticated

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'  # ビルド高速化
```

### 6.2 デプロイメント戦略

#### 環境別デプロイフロー
```mermaid
flowchart LR
    A[GitHub Push] --> B[Cloud Build Trigger]
    B --> C{Branch Check}
    C -->|feature/*| D[Development Deploy]
    C -->|main| E[Staging Deploy]
    E --> F[Integration Tests]
    F -->|Pass| G[Production Deploy]
    F -->|Fail| H[Rollback]
    G --> I[Health Check]
    I -->|Fail| H
    
    subgraph "Deployment Strategy"
        J[Blue-Green Deploy]
        K[Traffic Splitting]
        L[Gradual Rollout]
    end
    
    G --> J
    J --> K
    K --> L
```

#### 段階的ロールアウト
```yaml
Deployment Strategy:
  Development:
    Trigger: feature/* branch push
    Target: dev-phase*-service
    Traffic: 100%
    
  Staging:
    Trigger: main branch push
    Target: staging-phase*-service
    Testing: Automated integration tests
    
  Production:
    Trigger: Manual approval after staging
    Strategy: Blue-Green with traffic splitting
    Rollout:
      - Phase 1: 10% traffic for 10 minutes
      - Phase 2: 50% traffic for 30 minutes  
      - Phase 3: 100% traffic
    Rollback: Automatic if error rate > 1%
```

### 6.3 環境管理

#### 環境変数管理
```yaml
Environment Variables:
  Development:
    ENVIRONMENT: dev
    LOG_LEVEL: DEBUG
    REDIS_HOST: dev-redis-host
    DB_HOST: dev-db-host
    
  Staging:
    ENVIRONMENT: staging
    LOG_LEVEL: INFO
    REDIS_HOST: staging-redis-host
    DB_HOST: staging-db-host
    
  Production:
    ENVIRONMENT: production
    LOG_LEVEL: WARN
    REDIS_HOST: prod-redis-host
    DB_HOST: prod-db-host
    
Secret References:
  - GEMINI_API_KEY: projects/PROJECT_ID/secrets/gemini-api-key/versions/latest
  - IMAGEN_API_KEY: projects/PROJECT_ID/secrets/imagen-api-key/versions/latest
  - DB_PASSWORD: projects/PROJECT_ID/secrets/database-password/versions/latest
```

---


---

## 改訂履歴

| 版数 | 日付 | 変更内容 | 担当者 |
|------|------|----------|--------|
| 1.0 | 2025-01-20 | 初版作成（軽量スタートアップ構成） | Claude Code |

---

## インフラ整備状況

### 整備完了状況（2025-08-24 更新）

| サービス | 詳細 | 整備状況 | 月額コスト（目安） |
|----------|------|----------|-------------------|
| **ネットワーキング** |  |  |  |
| VPC Network | manga-service-vpc (10.0.0.0/16) | ✅ 完了 | $0（無料枠） |
| サブネット | パブリック: 10.0.1.0/24<br>プライベート: 10.0.2.0/24 | ✅ 完了 | $0（無料枠） |
| ファイアウォール | 内部通信、HTTPS、ヘルスチェック | ✅ 完了 | $0（無料枠） |
| VPC Peering | Service Networking用 | ✅ 完了 | $0（無料枠） |
| Direct VPC Egress | Cloud Run → VPC接続 | ✅ 設計変更済み | $0（無料） |
| **データベース** |  |  |  |
| Cloud SQL | PostgreSQL 15, db-f1-micro | 🔄 作成中 | $25-30/月 |
| Memory Store Redis | 1GB, Basic tier | ✅ 完了<br>IP: 10.85.114.155 | $40-50/月 |
| **ストレージ** |  |  |  |
| Input Data Bucket | 90日自動削除 | ✅ 完了 | $2-5/月 |
| Output Images Bucket | CDN対応、CORS有効 | ✅ 完了 | $5-15/月 |
| Final Products Bucket | ライフサイクル設定 | ✅ 完了 | $3-10/月 |
| Temp Data Bucket | 7日自動削除 | ✅ 完了 | $1-3/月 |
| **メッセージング** |  |  |  |
| ~~Pub/Sub Topics~~ | ~~phase-completed, generation-requests~~ | ❌ 削除済み | ~~$1-5/月~~ |
| ~~Pub/Sub Subscriptions~~ | ~~phase-completed-sub~~ | ❌ 削除済み | ~~$0（含まれる）~~ |
| **セキュリティ** |  |  |  |
| Service Accounts | Main, Dev用サービスアカウント | ✅ 完了 | $0（無料） |
| IAM Policies | 最小権限設定 | ✅ 完了 | $0（無料） |
| Service Networking | Private Google Access | ✅ 完了 | $0（無料） |
| **API** |  |  |  |
| AI Platform API | Vertex AI・Gemini Pro・Imagen統合 | ✅ 有効化済み | 使用量課金 |
| Cloud Run API | コンテナ実行 | ✅ 有効化済み | 使用量課金 |
| その他必要API | 12個すべて有効化 | ✅ 完了 | $0（無料） |

### 残作業・課題

| 項目 | 優先度 | 詳細 | 対応予定 |
|------|--------|------|---------|
| Cloud Run デプロイ | 中 | アプリケーション配置 | 開発完了後 |
| 監視・ログ設定 | 低 | プロダクション運用時 | 運用開始前 |
| パフォーマンスチューニング | 低 | Direct VPC Egress最適化 | 負荷テスト後 |

### ✅ **解決済み課題**
- ~~VPC Connector削除~~ → **完了（削除済み）**
- ~~Cloud SQL完了待ち~~ → **完了（DB・ユーザー作成済み）**
- ~~Vertex AI API権限~~ → **完了（AI Platform API経由で利用可能）**

### 現在のコスト見積もり（Direct VPC Egress採用後）
- **基盤コスト**: $76-128/月（実装済み、VPC Connector削除で$20-30削減）
- **API使用料**: 利用量に応じて変動
- **総合計**: $80-170/月（初期段階、月額$20-30の削減効果）

## 7. 開発環境設計

### 7.1 開発環境セットアップ

#### 必要システム要件
| 要素 | 要件 | 用途 |
|------|------|------|
| Python | 3.11+ | バックエンド開発 |
| Docker | Docker & Docker Compose | ローカルインフラ |
| PostgreSQL | 15+ | 開発用データベース |
| Redis | 7+ | 開発用キャッシュ |
| Node.js | 18+ | フロントエンド開発 |
| Google Cloud SDK | 最新版 | クラウド連携・デプロイ |

#### 必要なGoogle Cloud APIs
```
- Vertex AI API
- Cloud Storage API
- Secret Manager API
- Cloud SQL API
- Cloud Run API
```

### 7.2 バックエンド開発環境

#### 開発環境初期化
```bash
# 1. リポジトリクローン
git clone https://github.com/your-repo/manga-generation-service.git
cd manga-generation-service

# 2. Python仮想環境セットアップ
cd backend
python3 -m venv venv
source venv/bin/activate  # Mac/Linux
# or venv\Scripts\activate  # Windows

# 3. 依存関係インストール
pip install --upgrade pip
pip install -r requirements.txt
```

#### 開発用環境変数設定
```env
# Database
DATABASE_URL=postgresql+asyncpg://manga_user:manga_pass@localhost:5432/manga_db

# Redis
REDIS_URL=redis://localhost:6379/0

# Security
SECRET_KEY=your-secret-key-here-minimum-32-chars
JWT_ALGORITHM=HS256

# Google Cloud (開発時はオプション)
GOOGLE_CLOUD_PROJECT=your-project-id
GOOGLE_APPLICATION_CREDENTIALS=/path/to/credentials.json
VERTEXAI_LOCATION=asia-northeast1

# AI Models
GEMINI_MODEL=gemini-1.5-pro
IMAGEN_MODEL=imagen-4

# CORS (開発時)
CORS_ORIGINS=http://localhost:3000,http://localhost:8000

# Debug
DEBUG=true
ENV=development
```

#### Docker Compose開発インフラ
```yaml
# docker-compose.yml (開発用)
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: manga_db
      POSTGRES_USER: manga_user
      POSTGRES_PASSWORD: manga_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### 7.3 フロントエンド開発環境

#### セットアップ手順
```bash
cd frontend
npm install

# 環境変数設定
cp .env.example .env.local

# 開発サーバー起動
npm run dev
# http://localhost:3000 で確認
```

#### フロントエンド環境変数
```env
NEXT_PUBLIC_API_URL=http://localhost:8000/api/v1
NEXT_PUBLIC_WS_URL=ws://localhost:8000/ws
```

### 7.4 統合開発環境

#### 全サービス起動スクリプト
```bash
#!/bin/bash
# scripts/setup.sh

echo "🚀 AI Manga Generation Service - Development Setup"

# Docker インフラ起動
echo "📦 Starting infrastructure services..."
docker-compose up -d

# データベースマイグレーション
echo "🗃️ Running database migrations..."
cd backend
alembic upgrade head

# バックエンド起動
echo "⚙️ Starting backend service..."
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 &

# フロントエンド起動
echo "🎨 Starting frontend service..."
cd ../frontend
npm run dev &

echo "✅ Development environment ready!"
echo "📖 API Documentation: http://localhost:8000/docs"
echo "🌐 Frontend: http://localhost:3000"
```

### 7.5 開発ワークフロー

#### 1. フィーチャーブランチ作成
```bash
git checkout -b feature/your-feature-name
```

#### 2. 開発サイクル
| ステップ | コマンド | 詳細 |
|----------|----------|------|
| コード変更 | `vim app/...` | Phase Agent、API、サービス変更 |
| テスト実行 | `pytest tests/ -v` | Unit・Integration テスト |
| フォーマット | `black app/ tests/` | コード整形 |
| リント | `flake8 app/ tests/` | コード品質チェック |
| コミット | `git commit -m "feat: ..."` | 変更確定 |

#### 3. 品質保証
```bash
# Coverage report
pytest --cov=app --cov-report=html

# 型チェック
mypy app/

# セキュリティチェック
bandit -r app/
```

### 7.6 監視・デバッグ

#### ローカル監視
```bash
# アプリケーションログ
tail -f logs/app.log

# Docker サービス確認
docker-compose ps
docker-compose logs -f

# WebSocket接続テスト
wscat -c ws://localhost:8000/ws/session/test-session-id
```

#### パフォーマンス分析
```bash
# API レスポンス時間測定
curl -w "@curl-format.txt" -s -o /dev/null http://localhost:8000/api/v1/manga/generate

# メモリ使用量監視
python -m memory_profiler app/main.py
```

### 7.7 トラブルシューティング

#### 共通エラーと解決策
| エラー | 原因 | 解決策 |
|--------|------|--------|
| `pydantic-settings not found` | 依存関係不足 | `pip install pydantic-settings` |
| `psycopg2 compilation error` | PostgreSQL開発ライブラリ不足 | `brew install postgresql` (Mac) |
| `Redis connection refused` | Redisサービス未起動 | `docker-compose restart redis` |
| `Permission denied` | Docker権限不足 | `sudo usermod -aG docker $USER` |

#### デバッグコマンド
```bash
# DB接続テスト
psql postgresql://manga_user:manga_pass@localhost:5432/manga_db

# Redis接続テスト
redis-cli ping

# コンテナ状態確認
docker-compose ps
docker-compose logs <service-name>

# 全削除・再構築
docker-compose down -v
docker-compose up -d --build
```

### 7.8 プロダクション連携

#### Google Cloud接続設定
```bash
# プロジェクト設定
gcloud config set project YOUR_PROJECT_ID

# 認証設定
gcloud auth application-default login

# 必要なAPIを有効化
./scripts/gcloud-setup.sh
```

#### Cloud Runテスト環境デプロイ
```bash
# Docker イメージビルド
docker build -t gcr.io/YOUR_PROJECT_ID/manga-service .

# イメージプッシュ
docker push gcr.io/YOUR_PROJECT_ID/manga-service

# テスト環境デプロイ
gcloud run deploy manga-service-dev \
  --image gcr.io/YOUR_PROJECT_ID/manga-service \
  --platform managed \
  --region asia-northeast1 \
  --allow-unauthenticated
```

### 7.9 開発環境リソース

#### 必要なドキュメント
- API Documentation: http://localhost:8000/docs
- Backend Implementation Guide: `docs/Backend_Implementation_Guide.md`
- System Architecture: `docs/04.システム設計書.md`
- AI Implementation: `docs/08.AI設計書.md`

#### サポート体制
1. `docs/` ディレクトリのドキュメント確認
2. GitHub Issues での既知問題検索
3. 新規Issue作成・技術支援依頼

---

**文書承認**
- インフラアーキテクト: [署名] 日付: [日付]
- セキュリティエンジニア: [署名] 日付: [日付]
- SREエンジニア: [署名] 日付: [日付]