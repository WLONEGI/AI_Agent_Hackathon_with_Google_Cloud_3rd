# AI漫画生成サービス実装要件抽出結果

**文書管理情報**
- 文書ID: IMP-REQ-001
- 作成日: 2025-01-27
- 版数: 1.0
- 承認者: 根岸祐樹
- 分析対象: 13.プレビュー機能設計書.md、05.API設計書.md、06.データベース設計書.md、04.システム設計書.md、09.インフラ設計書.md、07.UI_UX設計書.md

---

## 1. 機能要件マップ

### Core Features

#### 1.1 統合漫画生成システム（モノリシック7フェーズ）
- **Phase 1**: コンセプト・世界観分析Agent → 10秒処理
- **Phase 2**: キャラクター設定・簡易ビジュアル生成Agent → 12秒処理
- **Phase 3**: プロット・ストーリー構成Agent → 8秒処理
- **Phase 4**: ネーム生成Agent → 12秒処理（最重要工程）
- **Phase 5**: シーン画像並列生成Agent → 40秒処理（Imagen 4使用）
- **Phase 6**: セリフ配置Agent → 6秒処理
- **Phase 7**: 最終統合・品質調整Agent → 9秒処理
- **合計処理時間**: 97秒（約8分目標）

#### 1.2 Human-in-the-Loop（HITL）フィードバック機能
- **各フェーズ完了後**: 30秒のユーザーフィードバック待機
- **フィードバック形式**: 自然言語入力・クイックオプション・スキップ機能
- **リアルタイム適用**: WebSocket経由での即時修正反映
- **修正対象**: コンセプト・ジャンル・キャラクター設定・プロット・画像品質等

#### 1.3 品質ゲートシステム
- **品質スコア管理**: 各フェーズで0.70以上の品質閾値
- **自動リトライ**: 最大3回までの品質向上再試行
- **管理者オーバーライド**: 品質閾値の手動承認機能

### Preview System Features

#### 1.4 フェーズ特化型プレビューシステム
- **Phase1プレビュー**: コンセプト・ジャンル・対象読者・世界観のインタラクティブ編集
- **Phase2プレビュー**: キャラクター詳細・ビジュアル選択・関係性グラフ編集
- **Phase3プレビュー**: シーン順序・感情曲線のドラッグ&ドロップ調整
- **Phase4プレビュー**: コマサイズ・配置・レイアウトのリサイズ・ドラッグ機能
- **Phase5プレビュー**: 生成画像の選択・スタイル調整・品質向上
- **Phase6プレビュー**: セリフ・吹き出し位置のテキスト編集・ドラッグ機能
- **Phase7プレビュー**: 最終ページ順序・出力設定の調整

#### 1.5 アダプティブ品質システム
- **5段階品質レベル**: ULTRA_LOW(1) → ULTRA_HIGH(5)
- **デバイス性能検出**: メモリ・CPU・画面解像度・ネットワーク速度
- **自動品質調整**: デバイス能力×ネットワーク状況による最適化
- **ユーザー設定**: 手動品質選択・自動適応ON/OFF

#### 1.6 ブランチ型バージョン管理
- **バージョンブランチ**: 親子関係を持つツリー構造での履歴管理
- **比較機能**: サイドバイサイド・オーバーレイ・差分ハイライト
- **復元機能**: 特定バージョンへの巻き戻し・新ブランチ作成
- **品質追跡**: 各バージョンの品質スコア記録

## 2. 技術スタック要件

### Backend Requirements

#### 2.1 アプリケーション基盤
- **言語**: Python 3.11
- **フレームワーク**: FastAPI + Pydantic
- **アーキテクチャ**: モノリシックサービス（単一コンテナ）
- **コンテナサイズ**: 8 vCPU, 32GB RAM
- **処理時間制限**: 600秒（10分）

#### 2.2 AI API統合
- **Google Gemini Pro**: テキスト処理（Phase 1-4, 6-7）
- **Google Imagen 4**: 画像生成（Phase 2, 5）
- **API制限管理**: Redis カウンターによる日次制限追跡
- **エラーハンドリング**: 指数バックオフによる3回リトライ

#### 2.3 データベース
- **メインDB**: PostgreSQL 15（Cloud SQL）
- **スキーマ**: users, manga_projects, generation_requests, phase_executions, feedback_requests, preview_versions等
- **パーティション**: api_usage_logs の月次パーティション
- **インデックス**: 複合インデックス・GINインデックス・部分インデックス

#### 2.4 キャッシュ・セッション管理
- **Redis**: Memory Store for Redis（1GB Basic tier）
- **用途**: WebSocketセッション・APIレート制限・プレビュー一時データ
- **TTL設定**: リクエストメタデータ24時間・セッション1時間

#### 2.5 プレビューシステム技術要件
- **データ構造**: フェーズ特化型TypeScript Interface
- **リアルタイム更新**: WebSocket + デバウンス処理（300ms）
- **品質レンダリング**: 品質レベル別の段階的コンテンツ生成
- **バージョン管理**: データベース + Cloud Storage のハイブリッド

### Frontend Requirements

#### 2.6 フロントエンド基盤
- **フレームワーク**: Next.js 14（App Router）
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS + CSS Variables
- **状態管理**: React Context + Custom Hooks

#### 2.7 UI/UXデザインシステム
- **デザイン哲学**: Genspark風モダンデザイン
- **カラー**: ダークモード基調（#1a1a1a背景）
- **レイアウト**: 左右分割（左:リアルタイムログ、右:プレビュー）
- **入力**: Claudeライク単一入力欄
- **テーマ**: ダークモード標準・ライトモード補助

#### 2.8 インタラクティブ機能
- **リアルタイム通信**: WebSocket接続・Custom Event システム
- **プレビューエディタ**: ドラッグ&ドロップ・リサイズ・テキスト編集
- **フィードバックUI**: 自然言語入力・クイックオプション・スキップボタン
- **進捗表示**: リアルタイムプログレスバー・フェーズ別詳細

### Infrastructure Requirements

#### 2.9 クラウドインフラ（GCP）
- **コンピューティング**: Cloud Run（serverless）
- **ネットワーク**: VPC（manga-service-vpc）+ Direct VPC Egress
- **ストレージ**: Cloud Storage（4バケット構成）+ CDN
- **監視**: Cloud Monitoring + Cloud Logging

#### 2.10 セキュリティ
- **認証**: Firebase Authentication + JWT
- **認可**: カスタムClaims + Row Level Security
- **データ暗号化**: TLS 1.3 + AES-256
- **Secret管理**: Secret Manager

## 3. 実装依存関係

### Critical Path Dependencies

#### 3.1 システム基盤構築（Phase 1）
```
1. インフラ基盤 → データベース → Redis
   ├─ Cloud Run環境構築
   ├─ PostgreSQL Cloud SQL セットアップ
   ├─ Memory Store Redis インスタンス
   └─ Cloud Storage バケット設定

2. 認証システム → ユーザー管理
   ├─ Firebase Authentication統合
   ├─ JWT トークン検証
   └─ ユーザーロール管理

3. 基本APIフレームワーク → エラーハンドリング
   ├─ FastAPI基盤構築
   ├─ 統一エラー処理システム
   └─ ログ・監視システム
```

#### 3.2 コア機能実装（Phase 2）
```
1. 7フェーズエンジン構築
   Phase1（コンセプト分析） → Phase2（キャラビジュアル） → 
   Phase3（プロット構成） → Phase4（ネーム生成） → 
   Phase5（画像生成） → Phase6（セリフ配置） → 
   Phase7（最終統合）

2. プレビューシステム基盤
   ├─ フェーズ特化型データ構造
   ├─ 品質レベル判定システム
   └─ CDN キャッシュ戦略

3. HITL フィードバックシステム
   ├─ WebSocket リアルタイム通信
   ├─ フィードバック解析・適用
   └─ 30秒タイムアウト処理
```

#### 3.3 プレビューシステム（Phase 3）
```
1. インタラクティブプレビュー機能
   ├─ リアルタイム編集機能
   ├─ ドラッグ&ドロップ処理
   └─ デバウンス処理（300ms）

2. バージョン管理システム
   ├─ ブランチ型データ構造
   ├─ 比較・差分表示
   └─ 復元機能

3. アダプティブ品質システム
   ├─ デバイス性能検出
   ├─ 自動品質調整
   └─ 段階的レンダリング
```

### Parallel Implementation Opportunities

#### 3.4 並行実装可能領域

**フロントエンド並行作業**:
```
Group A: 基本UI実装
├─ デザインシステム構築
├─ コンポーネントライブラリ
└─ レスポンシブレイアウト

Group B: インタラクション実装  
├─ WebSocket クライアント
├─ リアルタイム状態管理
└─ フィードバックUI

Group C: プレビューシステム
├─ インタラクティブエディタ
├─ バージョン比較UI
└─ 品質調整インターフェース
```

**バックエンド並行作業**:
```
Group A: 基盤システム
├─ データベースマイグレーション
├─ Redis セッション管理
└─ ログ・監視システム

Group B: AI統合システム
├─ Google AI APIクライアント
├─ プロンプト管理システム
└─ エラー・リトライ処理

Group C: プレビューバックエンド
├─ CDN キャッシュシステム
├─ バージョン管理API
└─ 品質評価システム
```

## 4. 品質・パフォーマンス制約

### Performance Constraints

#### 4.1 処理時間制約
- **全体処理時間**: 8分目標・10分最大（600秒）
- **フェーズ別目標**: Phase5（40秒）が最長・他は6-12秒
- **フィードバック応答**: 300ms以内のデバウンス処理
- **プレビュー生成**: 5秒以内の初期表示・段階的品質向上

#### 4.2 システムパフォーマンス
- **同時処理数**: 100リクエスト並行処理
- **スループット**: 500req/hour目標
- **API応答時間**: <100ms（キャッシュ利用時）
- **WebSocket接続**: 最大1000同時接続

#### 4.3 リソース制約
- **メモリ使用量**: 32GB RAM（単一コンテナ）
- **CPU使用率**: 8 vCPU・80%閾値でスケールアウト
- **ストレージ**: 100GB初期・500GB上限の自動拡張
- **ネットワーク**: VPC内部通信・Direct VPC Egress

### Quality Gates

#### 4.4 品質ゲート定義
- **コード品質**: 単体テストカバレッジ 85%以上
- **パフォーマンス**: Core Web Vitals全項目グリーン
- **セキュリティ**: OWASP Top 10 対策完備
- **アクセシビリティ**: WCAG 2.1 AA準拠

#### 4.5 AI生成品質管理
- **品質スコア閾値**: 各フェーズ0.70以上
- **リトライ上限**: 最大3回までの自動再試行
- **フォールバック**: エラー時のプレースホルダー生成
- **キャッシュ活用**: 類似コンテンツの85%類似度マッチング

#### 4.6 プレビューシステム品質
- **レンダリング品質**: デバイス性能に応じた5段階調整
- **インタラクション応答**: 100ms以内の操作フィードバック
- **バージョン管理**: 無制限履歴・60日保持期間
- **CDN配信**: 全世界1秒以内のプレビュー表示

## 5. 実装優先度マトリクス

### 🔴 Critical（必須・最優先）
1. **基盤システム**: インフラ・DB・認証（Week 1-2）
2. **7フェーズエンジン**: コア漫画生成ロジック（Week 3-6）
3. **基本プレビューシステム**: テキストベース表示（Week 4-5）
4. **HITL基本機能**: フィードバック受付・適用（Week 5-6）

### 🟡 Important（重要・次優先）
1. **インタラクティブプレビュー**: リアルタイム編集機能（Week 7-9）
2. **品質アダプティブシステム**: デバイス性能対応（Week 8-9）
3. **バージョン管理**: 履歴・比較機能（Week 10-11）
4. **UI/UXポリッシュ**: Genspark風デザイン完成（Week 9-12）

### 🟢 Optional（補助・将来実装）
1. **高度なアニメーション**: マイクロインタラクション
2. **オフライン対応**: Progressive Web App化
3. **多言語対応**: 国際化対応
4. **ソーシャル機能**: 作品共有・コメント機能

---

## 実装ロードマップ

### Week 1-2: 基盤構築
- インフラ環境構築（GCP）
- データベース設計・構築
- 認証システム統合

### Week 3-4: コアエンジン開発
- 7フェーズAgent基本実装
- Google AI API統合
- エラーハンドリング・リトライ

### Week 5-6: HITL・プレビュー基盤
- WebSocket通信システム
- 基本プレビューシステム
- フィードバック処理ロジック

### Week 7-8: インタラクティブ機能
- リアルタイム編集機能
- ドラッグ&ドロップUI
- 品質アダプティブシステム

### Week 9-10: バージョン管理・UI完成
- ブランチ型バージョン管理
- 比較・復元機能
- Genspark風UI完成

### Week 11-12: テスト・最適化・デプロイ
- 統合テスト・パフォーマンス調整
- セキュリティ監査・最適化
- プロダクションデプロイ

---

**改訂履歴**

| 版数 | 日付 | 変更内容 | 作成者 |
|------|------|----------|--------|
| 1.0 | 2025-01-27 | 初版作成（設計書6冊の統合分析結果） | Claude Code |

---

**文書承認**
- 要件アナリスト: [署名] 日付: [日付]
- システムアーキテクト: [署名] 日付: [日付]
- プロジェクトマネージャー: [署名] 日付: [日付]