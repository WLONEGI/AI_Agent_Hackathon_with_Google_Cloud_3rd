# 設計書に準拠していないAPI実装内容分析

## 分析対象
- 設計書: `/docs/05.API設計書.md` (API設計書 v2.0)
- 実装: `/backend/app/api/v1/*.py` (実際のAPI実装)

## 主要な非準拠項目

### 1. URLパス設計の不整合 🔴

**設計書の仕様:**
```
POST /api/v1/manga/generate
GET /api/v1/manga/{request_id}/status  
GET /api/v1/manga/{request_id}/stream
```

**実装の実際:**
```python
# manga_sessions.py
@router.post("/generate", ...)          # ✅ 準拠
@router.post("/", ...)                  # ❌ 非準拠 (重複エンドポイント)
@router.get("/{request_id}/status", ...) # ✅ 準拠
@router.get("/{request_id}/stream", ...)  # ✅ 準拠

# しかし以下が非準拠:
@router.get("/sessions", ...)           # ❌ 設計書に存在しない
@router.get("/sessions/{session_id}", ...) # ❌ 設計書に存在しない
@router.post("/sessions/{session_id}/pause", ...) # ❌ 設計書に存在しない
```

**影響度:** HIGH - フロントエンド連携時のURL不整合

### 2. レスポンスモデルの差異 🟡

**設計書の仕様 (POST /api/v1/manga/generate):**
```json
{
  "request_id": "uuid",
  "status": "queued", 
  "estimated_completion_time": "ISO8601",
  "performance_mode": "monolithic",
  "expected_duration_minutes": 8,
  "status_url": "/api/v1/manga/{request_id}/status",
  "sse_url": "/api/v1/manga/{request_id}/stream"
}
```

**実装の実際 (SessionResponse):**
```python
class SessionResponse(BaseModel):
    id: UUID                          # ✅ request_id相当
    title: Optional[str]              # ❌ 設計書に存在しない
    status: str                       # ✅ 準拠
    current_phase: int                # ❌ 設計書では current_module
    total_phases: int                 # ❌ 設計書では total_modules
    progress_percentage: float        # ❌ 設計書に存在しない
    created_at: datetime             # ❌ 設計書に存在しない
    updated_at: datetime             # ❌ 設計書に存在しない
    # 以下の設計書フィールドが欠落:
    # - estimated_completion_time
    # - performance_mode  
    # - expected_duration_minutes
    # - status_url
    # - sse_url
```

**影響度:** MEDIUM - APIレスポンス形式の不整合

### 3. リクエストモデルの差異 🟡

**設計書の仕様:**
```json
{
  "title": "string",
  "text": "string (max 50,000 chars)",
  "ai_auto_settings": true,
  "feedback_mode": {
    "enabled": true,
    "timeout_minutes": 30,
    "allow_skip": true
  },
  "options": {
    "priority": "normal|high",
    "webhook_url": "string (optional)",
    "auto_publish": "boolean"
  }
}
```

**実装の実際:**
```python
class SessionCreateRequest(BaseModel):
    title: Optional[str]              # ✅ 準拠
    input_text: str                   # ❌ 設計書では "text"
    generation_params: Dict[str, Any] # ❌ 設計書の構造と異なる
    # 以下の設計書フィールドが欠落:
    # - ai_auto_settings
    # - feedback_mode (enabled, timeout_minutes, allow_skip)
    # - options (priority, webhook_url, auto_publish)
```

**影響度:** HIGH - フロントエンド連携に直接影響

### 4. ステータス管理の差異 🟡

**設計書の仕様:**
- `current_module` (1-8)
- `total_modules` (8)
- `module_details` with processing_mode

**実装の実際:**
- `current_phase` (1-7)  
- `total_phases` (7)
- フェーズベース管理

**影響度:** MEDIUM - 進捗表示ロジックの差異

### 5. 品質ゲートAPI実装状況 ✅

**設計書で定義されたエンドポイント:**
```
GET /api/v1/manga/{request_id}/quality-gate
POST /api/v1/manga/{request_id}/phase/{phase}/quality-override  
GET /api/v1/quality/metrics
```

**実装状況:** ✅ **完全準拠**
- quality_gates.py で100%実装済み
- レスポンス形式も設計書準拠

### 6. プレビューインタラクティブAPI実装状況 ✅

**設計書で定義されたエンドポイント:**
```
GET /api/v1/manga/{request_id}/preview/{phase}
POST /api/v1/manga/{request_id}/preview/{phase}/apply-change
GET /api/v1/manga/{request_id}/preview/compare
```

**実装状況:** ✅ **完全準拠**
- preview_interactive.py で100%実装済み
- レスポンス形式も設計書準拠

### 7. フィードバックAPI実装状況 🟡

**設計書で定義されたエンドポイント:**
```
POST /api/v1/manga/{request_id}/feedback
GET /api/v1/manga/{request_id}/phase/{phase_number}/preview
GET /api/v1/manga/{request_id}/modification/{feedback_id}/status
POST /api/v1/manga/{request_id}/skip-feedback
```

**実装状況:** 🟡 **部分実装**
- feedback.py に基本構造はあるが、設計書の詳細仕様と差異あり

### 8. 作品管理API実装状況 ❌

**設計書で定義されたエンドポイント:**
```
GET /api/v1/manga (作品一覧)
GET /api/v1/manga/{manga_id} (作品詳細)
PUT /api/v1/manga/{manga_id} (作品更新)
DELETE /api/v1/manga/{manga_id} (作品削除)
POST /api/v1/manga/{manga_id}/publish (公開)
POST /api/v1/manga/{manga_id}/archive (アーカイブ)
```

**実装状況:** ❌ **未実装**
- 該当するAPIファイルが存在しない

## 準拠率サマリー

| API分野 | 準拠率 | 状態 | 備考 |
|---------|--------|------|------|
| 漫画生成API | 70% | 🟡 部分準拠 | URLパス・レスポンス形式に差異 |
| 品質ゲートAPI | 100% | ✅ 完全準拠 | 新規実装で完全準拠 |
| プレビューAPI | 100% | ✅ 完全準拠 | 新規実装で完全準拠 |
| フィードバックAPI | 60% | 🟡 部分準拠 | 基本構造のみ |
| 作品管理API | 0% | ❌ 未実装 | 完全未実装 |
| **全体平均** | **66%** | 🟡 **部分準拠** | 改善余地大 |

## 改善優先順位

### 🔴 Critical (即座対応)
1. **URLパス統一**: `/sessions` パス削除、`/manga` パス統一
2. **レスポンス形式修正**: 設計書準拠のレスポンスモデル実装
3. **リクエスト形式修正**: feedback_mode, options等の必須フィールド実装

### 🟡 Important (短期対応)
1. **作品管理API実装**: 基本的なCRUD操作
2. **フィードバックAPI完成**: 設計書仕様準拠
3. **ステータス管理統一**: module/phase表記の統一

### 🟢 Nice to have (中期対応)
1. **エラーハンドリング統一**: RFC 7807完全準拠
2. **バリデーション強化**: 入力制限・形式チェック
3. **パフォーマンス最適化**: レスポンス時間改善

## 修正推奨事項

### 1. manga_sessions.py修正案
```python
# 設計書準拠のレスポンスモデルに変更
class SessionResponse(BaseModel):
    request_id: UUID  # idから変更
    status: str
    estimated_completion_time: Optional[str]  # 新規追加
    performance_mode: str = "monolithic"       # 新規追加
    expected_duration_minutes: int = 8         # 新規追加
    status_url: str                           # 新規追加
    sse_url: str                              # 新規追加
    # current_phase → current_module
    # total_phases → total_modules
```

### 2. 不要エンドポイント削除
```python
# 以下のエンドポイントを削除（設計書に存在しない）
# @router.get("/sessions", ...)
# @router.get("/sessions/{session_id}", ...)
# @router.post("/sessions/{session_id}/pause", ...)
```

### 3. 作品管理API新規実装
```python
# 新規ファイル: manga_works.py
@router.get("/manga", response_model=List[MangaWorkResponse])
@router.get("/manga/{manga_id}", response_model=MangaWorkDetailResponse) 
@router.put("/manga/{manga_id}", response_model=MangaWorkResponse)
@router.delete("/manga/{manga_id}", status_code=204)
```

この分析に基づいて、設計書準拠のAPI実装への修正作業を実施することを推奨します。